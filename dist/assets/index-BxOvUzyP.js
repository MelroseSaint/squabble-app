var Lt=Object.defineProperty;var $t=(r,e,t)=>e in r?Lt(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var a=(r,e,t)=>$t(r,typeof e!="symbol"?e+"":e,t);/**
 * uuidv7: A JavaScript implementation of UUID version 7
 *
 * Copyright 2021-2025 LiosK
 *
 * @license Apache-2.0
 * @packageDocumentation
 */const V="0123456789abcdef";class b{constructor(e){this.bytes=e}static ofInner(e){if(e.length!==16)throw new TypeError("not 128-bit length");return new b(e)}static fromFieldsV7(e,t,n,s){if(!Number.isInteger(e)||!Number.isInteger(t)||!Number.isInteger(n)||!Number.isInteger(s)||e<0||t<0||n<0||s<0||e>0xffffffffffff||t>4095||n>1073741823||s>4294967295)throw new RangeError("invalid field value");const o=new Uint8Array(16);return o[0]=e/2**40,o[1]=e/2**32,o[2]=e/2**24,o[3]=e/2**16,o[4]=e/2**8,o[5]=e,o[6]=112|t>>>8,o[7]=t,o[8]=128|n>>>24,o[9]=n>>>16,o[10]=n>>>8,o[11]=n,o[12]=s>>>24,o[13]=s>>>16,o[14]=s>>>8,o[15]=s,new b(o)}static parse(e){var t,n,s,o;let i;switch(e.length){case 32:i=(t=/^[0-9a-f]{32}$/i.exec(e))===null||t===void 0?void 0:t[0];break;case 36:i=(n=/^([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})$/i.exec(e))===null||n===void 0?void 0:n.slice(1,6).join("");break;case 38:i=(s=/^\{([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})\}$/i.exec(e))===null||s===void 0?void 0:s.slice(1,6).join("");break;case 45:i=(o=/^urn:uuid:([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})$/i.exec(e))===null||o===void 0?void 0:o.slice(1,6).join("");break}if(i){const c=new Uint8Array(16);for(let l=0;l<16;l+=4){const h=parseInt(i.substring(2*l,2*l+8),16);c[l+0]=h>>>24,c[l+1]=h>>>16,c[l+2]=h>>>8,c[l+3]=h}return new b(c)}else throw new SyntaxError("could not parse UUID string")}toString(){let e="";for(let t=0;t<this.bytes.length;t++)e+=V.charAt(this.bytes[t]>>>4),e+=V.charAt(this.bytes[t]&15),(t===3||t===5||t===7||t===9)&&(e+="-");return e}toHex(){let e="";for(let t=0;t<this.bytes.length;t++)e+=V.charAt(this.bytes[t]>>>4),e+=V.charAt(this.bytes[t]&15);return e}toJSON(){return this.toString()}getVariant(){const e=this.bytes[8]>>>4;if(e<0)throw new Error("unreachable");if(e<=7)return this.bytes.every(t=>t===0)?"NIL":"VAR_0";if(e<=11)return"VAR_10";if(e<=13)return"VAR_110";if(e<=15)return this.bytes.every(t=>t===255)?"MAX":"VAR_RESERVED";throw new Error("unreachable")}getVersion(){return this.getVariant()==="VAR_10"?this.bytes[6]>>>4:void 0}clone(){return new b(this.bytes.slice(0))}equals(e){return this.compareTo(e)===0}compareTo(e){for(let t=0;t<16;t++){const n=this.bytes[t]-e.bytes[t];if(n!==0)return Math.sign(n)}return 0}}class pt{constructor(e){this.timestamp_biased=0,this.counter=0,this.random=e??Pt()}generate(){return this.generateOrResetCore(Date.now(),1e4)}generateOrAbort(){return this.generateOrAbortCore(Date.now(),1e4)}generateOrResetCore(e,t){let n=this.generateOrAbortCore(e,t);return n===void 0&&(this.timestamp_biased=0,n=this.generateOrAbortCore(e,t)),n}generateOrAbortCore(e,t){if(!Number.isInteger(e)||e<0||e>0xffffffffffff)throw new RangeError("`unixTsMs` must be a 48-bit unsigned integer");if(t<0||t>0xffffffffffff)throw new RangeError("`rollbackAllowance` out of reasonable range");if(e++,e>this.timestamp_biased)this.timestamp_biased=e,this.resetCounter();else if(e+t>=this.timestamp_biased)this.counter++,this.counter>4398046511103&&(this.timestamp_biased++,this.resetCounter());else return;return b.fromFieldsV7(this.timestamp_biased-1,Math.trunc(this.counter/2**30),this.counter&2**30-1,this.random.nextUint32())}resetCounter(){this.counter=this.random.nextUint32()*1024+(this.random.nextUint32()&1023)}generateV4(){const e=new Uint8Array(Uint32Array.of(this.random.nextUint32(),this.random.nextUint32(),this.random.nextUint32(),this.random.nextUint32()).buffer);return e[6]=64|e[6]>>>4,e[8]=128|e[8]>>>2,b.ofInner(e)}}const Pt=()=>{if(typeof crypto<"u"&&typeof crypto.getRandomValues<"u")return new Gt;if(typeof UUIDV7_DENY_WEAK_RNG<"u"&&UUIDV7_DENY_WEAK_RNG)throw new Error("no cryptographically strong RNG available");return{nextUint32:()=>Math.trunc(Math.random()*65536)*65536+Math.trunc(Math.random()*65536)}};class Gt{constructor(){this.buffer=new Uint32Array(8),this.cursor=65535}nextUint32(){return this.cursor>=this.buffer.length&&(crypto.getRandomValues(this.buffer),this.cursor=0),this.buffer[this.cursor++]}}let te;const Bt=()=>(te||(te=new pt)).generate(),Vt=()=>(te||(te=new pt)).generateV4();function Ft(){if(typeof WebSocket<"u")return WebSocket;if(typeof global.WebSocket<"u")return global.WebSocket;if(typeof window.WebSocket<"u")return window.WebSocket;if(typeof self.WebSocket<"u")return self.WebSocket;throw new Error("`WebSocket` is not supported in this environment")}const Ce=Ft();var Jt=Object.defineProperty,Wt=(r,e)=>{for(var t in e)Jt(r,t,{get:e[t],enumerable:!0})},qt=class{constructor({interceptors:r}={}){a(this,"collectable",{});a(this,"listeners",{});a(this,"interceptors");this.interceptors=r??{}}subscribe(r,e,t=!1){var n;if(this.listeners[r]||(this.listeners[r]=[]),!this.isSubscribed(r,e)&&((n=this.listeners[r])==null||n.push(e),t&&this.collectable[r])){let s=this.collectable[r];delete this.collectable[r];for(let o of s)e(...o)}}async subscribeOnce(r,e=!1){var t,n;if(e&&this.collectable[r]){let s=(t=this.collectable[r])==null?void 0:t.shift();if(((n=this.collectable[r])==null?void 0:n.length)===0&&delete this.collectable[r],s)return s}return new Promise(s=>{let o=!1,i=(...c)=>{o||(o=!0,this.unSubscribe(r,i),s(c))};this.subscribe(r,i,!1)})}unSubscribe(r,e){var t,n,s;if(this.listeners[r]){let o=(t=this.listeners[r])==null?void 0:t.findIndex(i=>i===e);o>=0&&((n=this.listeners[r])==null||n.splice(o,1),((s=this.listeners[r])==null?void 0:s.length)===0&&delete this.listeners[r])}}isSubscribed(r,e){var t;return!!((t=this.listeners[r])!=null&&t.includes(e))}async emit(r,e,t=!1){var o,i;let n=this.interceptors[r],s=n?await n(...e):e;(t&&!this.listeners[r]||((o=this.listeners[r])==null?void 0:o.length)===0)&&(this.collectable[r]||(this.collectable[r]=[]),(i=this.collectable[r])==null||i.push(e));for(let c of this.listeners[r]??[])c(...s)}reset({collectable:r,listeners:e}){if(Array.isArray(r))for(let t of r)delete this.collectable[t];else typeof r=="string"?delete this.collectable[r]:r!==!1&&(this.collectable={});if(Array.isArray(e))for(let t of e)delete this.listeners[t];else typeof e=="string"?delete this.listeners[e]:e!==!1&&(this.listeners={})}scanListeners(r){let e=Object.keys(this.listeners);return r&&(e=e.filter(r)),e}},ae=class{constructor(...r){a(this,"args",[]);this.args=r}fill(r){return[this,r]}hasDefault(){return this.args.length===1}get default(){return this.args[0]}},Yt={};Wt(Yt,{CborBreak:()=>Y,CborError:()=>R,CborFillMissing:()=>mt,CborInvalidMajorError:()=>ce,CborNumberError:()=>we,CborPartialDisabled:()=>wt,CborRangeError:()=>g,Encoded:()=>Ee,Gap:()=>ae,POW_2_53:()=>Xt,POW_2_64:()=>fe,PartiallyEncoded:()=>Se,Reader:()=>me,Tagged:()=>f,Writer:()=>G,decode:()=>bt,encode:()=>T,infiniteBytes:()=>be,partiallyEncodeObject:()=>Ae});var Xt=9007199254740992,fe=BigInt(18446744073709552e3),Ee=class{constructor(r){this.encoded=r}},u=class extends Error{},y=class extends u{constructor(){super(...arguments);a(this,"name","NoActiveSocket");a(this,"message","No socket is currently connected to a SurrealDB instance. Please call the .connect() method first!")}},Tr=class extends u{constructor(){super(...arguments);a(this,"name","NoConnectionDetails");a(this,"message","No connection details for the HTTP api have been provided. Please call the .connect() method first!")}},kr=class extends u{constructor(){super(...arguments);a(this,"name","UnexpectedResponse");a(this,"message","The returned response from the SurrealDB instance is in an unexpected format. Unable to process response!")}},Mr=class extends u{constructor(){super(...arguments);a(this,"name","InvalidURLProvided");a(this,"message","The provided string is either not a URL or is a URL but with an invalid protocol!")}},Kt=class extends u{constructor(){super(...arguments);a(this,"name","NoURLProvided");a(this,"message","Tried to establish a connection while no connection URL was provided")}},pe=class extends u{constructor(){super(...arguments);a(this,"name","EngineDisconnected");a(this,"message","The engine reported the connection to SurrealDB has dropped")}},Te=class extends u{constructor(){super(...arguments);a(this,"name","ReconnectFailed");a(this,"message","The engine failed to reconnect to SurrealDB")}},zt=class extends u{constructor(){super(...arguments);a(this,"name","ReconnectIterationError");a(this,"message","The reconnect iterator failed to iterate")}},ke=class extends u{constructor(e){super();a(this,"name","UnexpectedServerResponse");this.response=e,this.message=`${e}`}},Qt=class extends u{constructor(e){super();a(this,"name","UnexpectedConnectionError");this.error=e,this.message=`${e}`}},Zt=class extends u{constructor(e){super();a(this,"name","UnsupportedEngine");a(this,"message","The engine you are trying to connect to is not supported or configured.");this.engine=e}},Dr=class extends u{constructor(){super(...arguments);a(this,"name","FeatureUnavailableForEngine");a(this,"message","The feature you are trying to use is not available on this engine.")}},N=class extends u{constructor(){super(...arguments);a(this,"name","ConnectionUnavailable");a(this,"message","There is no connection available at this moment.")}},Ht=class extends u{constructor(){super(...arguments);a(this,"name","MissingNamespaceDatabase");a(this,"message","There is no namespace and/or database selected.")}},er=class extends u{constructor(e,t,n,s){super();a(this,"name","HttpConnectionError");this.message=e,this.status=t,this.statusText=n,this.buffer=s}},d=class extends u{constructor(e){super();a(this,"name","ResponseError");this.message=e}},tr=class extends u{constructor(){super(...arguments);a(this,"name","NoNamespaceSpecified");a(this,"message","Please specify a namespace to use.")}},rr=class extends u{constructor(){super(...arguments);a(this,"name","NoDatabaseSpecified");a(this,"message","Please specify a database to use.")}},Me=class extends u{constructor(){super(...arguments);a(this,"name","NoTokenReturned");a(this,"message","Did not receive an authentication token.")}},nr=class extends u{constructor(e,t){super();a(this,"name","UnsupportedVersion");a(this,"version");a(this,"supportedRange");this.version=e,this.supportedRange=t,this.message=`The version "${e}" reported by the engine is not supported by this library, expected a version that satisfies "${t}".`}},De=class extends u{constructor(e){super();a(this,"name","VersionRetrievalFailure");a(this,"message","Failed to retrieve remote version. If the server is behind a proxy, make sure it's configured correctly.");this.error=e}},R=class extends u{constructor(e){super();a(this,"message");this.message=e}},we=class extends R{constructor(){super(...arguments);a(this,"name","CborNumberError")}},g=class extends R{constructor(){super(...arguments);a(this,"name","CborRangeError")}},ce=class extends R{constructor(){super(...arguments);a(this,"name","CborInvalidMajorError")}},Y=class extends R{constructor(){super("Came across a break which was not intercepted by the decoder");a(this,"name","CborBreak")}},wt=class extends R{constructor(){super("Tried to insert a Gap into a CBOR value, while partial mode is not enabled");a(this,"name","CborPartialDisabled")}},mt=class extends R{constructor(){super("Fill for a gap is missing, and gap has no default");a(this,"name","CborFillMissing")}},G=class{constructor(r=256){a(this,"_chunks",[]);a(this,"_pos",0);a(this,"_buf");a(this,"_view");a(this,"_byte");this.byteLength=r,this._buf=new ArrayBuffer(this.byteLength),this._view=new DataView(this._buf),this._byte=new Uint8Array(this._buf)}chunk(r){this._chunks.push([this._buf.slice(0,this._pos),r]),this._buf=new ArrayBuffer(this.byteLength),this._view=new DataView(this._buf),this._byte=new Uint8Array(this._buf),this._pos=0}get chunks(){return this._chunks}get buffer(){return this._buf.slice(0,this._pos)}claim(r){let e=this._pos;if(this._pos+=r,this._pos<=this._buf.byteLength)return e;let t=this._buf.byteLength<<1;for(;t<this._pos;)t<<=1;if(t>this._buf.byteLength){let n=this._byte;this._buf=new ArrayBuffer(t),this._view=new DataView(this._buf),this._byte=new Uint8Array(this._buf),this._byte.set(n)}return e}writeUint8(r){let e=this.claim(1);this._view.setUint8(e,r)}writeUint16(r){let e=this.claim(2);this._view.setUint16(e,r)}writeUint32(r){let e=this.claim(4);this._view.setUint32(e,r)}writeUint64(r){let e=this.claim(8);this._view.setBigUint64(e,r)}writeUint8Array(r){if(r.byteLength===0)return;let e=this.claim(r.byteLength);this._byte.set(r,e)}writeArrayBuffer(r){r.byteLength!==0&&this.writeUint8Array(new Uint8Array(r))}writePartiallyEncoded(r){for(let[e,t]of r.chunks)this.writeArrayBuffer(e),this.chunk(t);this.writeArrayBuffer(r.end)}writeFloat32(r){let e=this.claim(4);this._view.setFloat32(e,r)}writeFloat64(r){let e=this.claim(8);this._view.setFloat64(e,r)}writeMajor(r,e){let t=r<<5;e<24?this.writeUint8(t+Number(e)):e<256?(this.writeUint8(t+24),this.writeUint8(Number(e))):e<65536?(this.writeUint8(t+25),this.writeUint16(Number(e))):e<4294967296?(this.writeUint8(t+26),this.writeUint32(Number(e))):(this.writeUint8(t+27),this.writeUint64(BigInt(e)))}output(r,e){return r?new Se(this._chunks,this.buffer,e):this.buffer}},Se=class{constructor(r,e,t){this.chunks=r,this.end=e,this.replacer=t}build(r,e){let t=new G,n=new Map(r);for(let[s,o]of this.chunks){let i=n.has(o)||o.hasDefault();if(!e&&!i)throw new mt;if(t.writeArrayBuffer(s),i){let c=n.get(o)??o.default;T(c,{writer:t,replacer:this.replacer})}else t.chunk(o)}return t.writeArrayBuffer(this.end),t.output(!!e,this.replacer)}};function Ae(r,e){return Object.fromEntries(Object.entries(r).map(([t,n])=>[t,T(n,{...e,partial:!0})]))}var f=class{constructor(r,e){this.tag=r,this.value=e}},Ie;function T(r,e={}){let t=e.writer??new G,n=new Map(e.fills??[]);function s(o){let i=e.replacer?e.replacer(o):o;if(i===void 0)return t.writeUint8(247);if(i===null)return t.writeUint8(246);if(i===!0)return t.writeUint8(245);if(i===!1)return t.writeUint8(244);switch(typeof i){case"number":{if(Number.isInteger(i))if(i>=0&&i<=9007199254740992)t.writeMajor(0,i);else if(i<0&&i>=-9007199254740992)t.writeMajor(1,-(i+1));else throw new we("Number too big to be encoded");else t.writeUint8(251),t.writeFloat64(i);return}case"bigint":{if(i>=0&&i<fe)t.writeMajor(0,i);else if(i<=0&&i>=-fe)t.writeMajor(1,-(i+1n));else throw new we("BigInt too big to be encoded");return}case"string":{Ie??(Ie=new TextEncoder);let c=Ie.encode(i);t.writeMajor(3,c.byteLength),t.writeUint8Array(c);return}default:{if(Array.isArray(i)){t.writeMajor(4,i.length);for(let l of i)s(l);return}if(i instanceof f){t.writeMajor(6,i.tag),s(i.value);return}if(i instanceof Ee){t.writeArrayBuffer(i.encoded);return}if(i instanceof ae){if(n.has(i))s(n.get(i));else{if(!e.partial)throw new wt;t.chunk(i)}return}if(i instanceof Se){let l=i.build(e.fills??[],e.partial);e.partial?t.writePartiallyEncoded(l):t.writeArrayBuffer(l);return}if(i instanceof Uint8Array||i instanceof Uint16Array||i instanceof Uint32Array||i instanceof Int8Array||i instanceof Int16Array||i instanceof Int32Array||i instanceof Float32Array||i instanceof Float64Array||i instanceof ArrayBuffer){let l=new Uint8Array(i);t.writeMajor(2,l.byteLength),t.writeUint8Array(l);return}let c=i instanceof Map?Array.from(i.entries()):Object.entries(i);t.writeMajor(5,c.length);for(let l of c.flat())s(l)}}}return s(r),t.output(!!e.partial,e.replacer)}var me=class{constructor(r){a(this,"_buf");a(this,"_view");a(this,"_byte");a(this,"_pos",0);this._buf=new ArrayBuffer(r.byteLength),this._view=new DataView(this._buf),this._byte=new Uint8Array(this._buf),this._byte.set(new Uint8Array(r))}read(r,e){return this._pos+=r,e}readUint8(){try{return this.read(1,this._view.getUint8(this._pos))}catch(r){throw r instanceof RangeError?new g(r.message):r}}readUint16(){try{return this.read(2,this._view.getUint16(this._pos))}catch(r){throw r instanceof RangeError?new g(r.message):r}}readUint32(){try{return this.read(4,this._view.getUint32(this._pos))}catch(r){throw r instanceof RangeError?new g(r.message):r}}readUint64(){try{return this.read(8,this._view.getBigUint64(this._pos))}catch(r){throw r instanceof RangeError?new g(r.message):r}}readFloat16(){let r=this.readUint16(),e=(r&32768)>>15,t=(r&31744)>>10,n=r&1023;return t===0?(e?-1:1)*2**-14*(n/2**10):t===31?n?Number.NaN:(e?-1:1)*Number.POSITIVE_INFINITY:(e?-1:1)*2**(t-15)*(1+n/2**10)}readFloat32(){try{return this.read(4,this._view.getFloat32(this._pos))}catch(r){throw r instanceof RangeError?new g(r.message):r}}readFloat64(){try{return this.read(8,this._view.getFloat64(this._pos))}catch(r){throw r instanceof RangeError?new g(r.message):r}}readBytes(r){let e=this._byte.length-this._pos;if(e<r)throw new g(`The argument must be between 0 and ${e}`);return this.read(r,this._byte.slice(this._pos,this._pos+r))}readMajor(){let r=this.readUint8(),e=r>>5;if(e<0||e>7)throw new ce("Received invalid major type");return[e,r&31]}readMajorLength(r){if(r<=23)return r;switch(r){case 24:return this.readUint8();case 25:return this.readUint16();case 26:return this.readUint32();case 27:{let e=this.readUint64();return e>9007199254740992?e:Number(e)}}throw new g("Expected a final length")}};function be(r,e){let t=new G;for(;;){let[n,s]=r.readMajor();if(n===7&&s===31)break;if(n!==e)throw new ce(`Expected a resource of the same major (${e}) while processing an infinite resource`);if(s===31)throw new g("Expected a finite resource while processing an infinite resource");t.writeUint8Array(r.readBytes(Number(r.readMajorLength(s))))}return t.buffer}var je;function bt(r,e={}){let t=r instanceof me?r:new me(r);function n(){let[o,i]=t.readMajor();switch(o){case 0:return t.readMajorLength(i);case 1:{let c=t.readMajorLength(i);return typeof c=="bigint"?-(c+1n):-(c+1)}case 2:return i===31?be(t,2):t.readBytes(Number(t.readMajorLength(i))).buffer;case 3:{let c=i===31?be(t,3):t.readBytes(Number(t.readMajorLength(i)));return je??(je=new TextDecoder),je.decode(c)}case 4:{if(i===31){let h=[];for(;;)try{h.push(s())}catch(p){if(p instanceof Y)break;throw p}return h}let c=t.readMajorLength(i),l=Array(c);for(let h=0;h<c;h++)l[h]=s();return l}case 5:{let c=[];if(i===31)for(;;){let l;try{l=s()}catch(p){if(p instanceof Y)break;throw p}let h=s();c.push([l,h])}else{let l=t.readMajorLength(i);for(let h=0;h<l;h++){let p=s(),_=s();c[h]=[p,_]}}return e.map==="map"?new Map(c):Object.fromEntries(c)}case 6:{let c=t.readMajorLength(i),l=s();return new f(c,l)}case 7:switch(i){case 20:return!1;case 21:return!0;case 22:return null;case 23:return;case 25:return t.readFloat16();case 26:return t.readFloat32();case 27:return t.readFloat64();case 31:throw new Y}}throw new ce(`Unable to decode value with major tag ${o}`)}function s(){return e.replacer?e.replacer(n()):n()}return s()}function sr(r){let e=Math.floor(r.getTime()/1e3),t=r.getTime()-e*1e3;return[e,t*1e6]}function ir([r,e]){let t=new Date(0);return t.setUTCSeconds(Number(r)),t.setMilliseconds(Math.floor(Number(e)/1e6)),t}var m=class{},P=class gt extends m{constructor(t){super();a(this,"decimal");this.decimal=t.toString()}equals(t){return t instanceof gt?this.decimal===t.decimal:!1}toString(){return this.decimal}toJSON(){return this.decimal}},xe=1,O=xe/1e3,ge=O/1e3,re=1e3*xe,ne=60*re,se=60*ne,ie=24*se,ye=7*ie,Re=new Map([["ns",ge],["µs",O],["μs",O],["us",O],["ms",xe],["s",re],["m",ne],["h",se],["d",ie],["w",ye]]),or=Array.from(Re).reduce((r,[e,t])=>(r.set(t,e),r),new Map),ar=new RegExp(`^(\\d+)(${Array.from(Re.keys()).join("|")})`),$=class w extends m{constructor(t){super();a(this,"_milliseconds");t instanceof w?this._milliseconds=t._milliseconds:typeof t=="string"?this._milliseconds=w.parseString(t):this._milliseconds=t}static fromCompact([t,n]){t=t??0,n=n??0;let s=t*1e3+n/1e6;return new w(s)}equals(t){return t instanceof w?this._milliseconds===t._milliseconds:!1}toCompact(){let t=Math.floor(this._milliseconds/1e3),n=Math.floor((this._milliseconds-t*1e3)*1e6);return n>0?[t,n]:t>0?[t]:[]}toString(){let t=this._milliseconds,n="";function s(o){let i=Math.floor(t/o);return i>0&&(t=t%o),i}for(let[o,i]of Array.from(or).reverse()){let c=s(o);c>0&&(n+=`${c}${i}`)}return n}toJSON(){return this.toString()}static parseString(t){let n=0,s=t;for(;s!=="";){let o=s.match(ar);if(o){let i=Number.parseInt(o[1]),c=Re.get(o[2]);if(c===void 0)throw new u(`Invalid duration unit: ${o[2]}`);n+=i*c,s=s.slice(o[0].length);continue}throw new u("Could not match a next duration part")}return n}static nanoseconds(t){return new w(Math.floor(t*ge))}static microseconds(t){return new w(Math.floor(t*O))}static milliseconds(t){return new w(t)}static seconds(t){return new w(t*re)}static minutes(t){return new w(t*ne)}static hours(t){return new w(t*se)}static days(t){return new w(t*ie)}static weeks(t){return new w(t*ye)}get microseconds(){return Math.floor(this._milliseconds/O)}get nanoseconds(){return Math.floor(this._milliseconds/ge)}get milliseconds(){return Math.floor(this._milliseconds)}get seconds(){return Math.floor(this._milliseconds/re)}get minutes(){return Math.floor(this._milliseconds/ne)}get hours(){return Math.floor(this._milliseconds/se)}get days(){return Math.floor(this._milliseconds/ie)}get weeks(){return Math.floor(this._milliseconds/ye)}},oe=class yt extends m{constructor(e){super(),this.inner=e}equals(e){return e instanceof yt?this.inner===e.inner:!1}toJSON(){return this.toString()}toString(){return`<future> ${this.inner}`}},v=class _t extends m{equals(e){return e instanceof _t?this.is(e):!1}toString(){return JSON.stringify(this.toJSON())}};function Le(r){return r instanceof P?Number.parseFloat(r.decimal):r}var $e=class X extends v{constructor(t){super();a(this,"point");t instanceof X?this.point=t.clone().point:this.point=[Le(t[0]),Le(t[1])]}toJSON(){return{type:"Point",coordinates:this.coordinates}}get coordinates(){return this.point}is(t){return t instanceof X?this.point[0]===t.point[0]&&this.point[1]===t.point[1]:!1}clone(){return new X([...this.point])}},Pe=class K extends v{constructor(t){super();a(this,"line");this.line=t instanceof K?t.clone().line:t}toJSON(){return{type:"LineString",coordinates:this.coordinates}}get coordinates(){return this.line.map(t=>t.coordinates)}close(){this.line[0].is(this.line.at(-1))||this.line.push(this.line[0])}is(t){if(!(t instanceof K)||this.line.length!==t.line.length)return!1;for(let n=0;n<this.line.length;n++)if(!this.line[n].is(t.line[n]))return!1;return!0}clone(){return new K(this.line.map(t=>t.clone()))}},Ge=class z extends v{constructor(t){super();a(this,"polygon");this.polygon=t instanceof z?t.clone().polygon:t.map(n=>{let s=n.clone();return s.close(),s})}toJSON(){return{type:"Polygon",coordinates:this.coordinates}}get coordinates(){return this.polygon.map(t=>t.coordinates)}is(t){if(!(t instanceof z)||this.polygon.length!==t.polygon.length)return!1;for(let n=0;n<this.polygon.length;n++)if(!this.polygon[n].is(t.polygon[n]))return!1;return!0}clone(){return new z(this.polygon.map(t=>t.clone()))}},Be=class Q extends v{constructor(t){super();a(this,"points");this.points=t instanceof Q?t.points:t}toJSON(){return{type:"MultiPoint",coordinates:this.coordinates}}get coordinates(){return this.points.map(t=>t.coordinates)}is(t){if(!(t instanceof Q)||this.points.length!==t.points.length)return!1;for(let n=0;n<this.points.length;n++)if(!this.points[n].is(t.points[n]))return!1;return!0}clone(){return new Q(this.points.map(t=>t.clone()))}},Ve=class Z extends v{constructor(t){super();a(this,"lines");this.lines=t instanceof Z?t.lines:t}toJSON(){return{type:"MultiLineString",coordinates:this.coordinates}}get coordinates(){return this.lines.map(t=>t.coordinates)}is(t){if(!(t instanceof Z)||this.lines.length!==t.lines.length)return!1;for(let n=0;n<this.lines.length;n++)if(!this.lines[n].is(t.lines[n]))return!1;return!0}clone(){return new Z(this.lines.map(t=>t.clone()))}},Fe=class H extends v{constructor(t){super();a(this,"polygons");this.polygons=t instanceof H?t.polygons:t}toJSON(){return{type:"MultiPolygon",coordinates:this.coordinates}}get coordinates(){return this.polygons.map(t=>t.coordinates)}is(t){if(!(t instanceof H)||this.polygons.length!==t.polygons.length)return!1;for(let n=0;n<this.polygons.length;n++)if(!this.polygons[n].is(t.polygons[n]))return!1;return!0}clone(){return new H(this.polygons.map(t=>t.clone()))}},Je=class ee extends v{constructor(t){super();a(this,"collection");this.collection=t instanceof ee?t.collection:t}toJSON(){return{type:"GeometryCollection",geometries:this.geometries}}get geometries(){return this.collection.map(t=>t.toJSON())}is(t){if(!(t instanceof ee)||this.collection.length!==t.collection.length)return!1;for(let n=0;n<this.collection.length;n++)if(!this.collection[n].is(t.collection[n]))return!1;return!0}clone(){return new ee(this.collection.map(t=>t.clone()))}};function k(r,e){if(Object.is(r,e))return!0;if(r instanceof Date&&e instanceof Date)return r.getTime()===e.getTime();if(r instanceof RegExp&&e instanceof RegExp)return r.toString()===e.toString();if(r instanceof m&&e instanceof m)return r.equals(e);if(typeof r!="object"||r===null||typeof e!="object"||e===null)return!1;let t=Reflect.ownKeys(r),n=Reflect.ownKeys(e);if(t.length!==n.length)return!1;for(let s=0;s<t.length;s++)if(!Reflect.has(e,t[s])||!k(r[t[s]],e[t[s]]))return!1;return!0}var cr=9223372036854775807n;function le(r){if(hr(r))return`⟨${r}⟩`;if(r==="")return"⟨⟩";let e,t,n;for(t=0,n=r.length;t<n;t++)if(e=r.charCodeAt(t),!(e>47&&e<58)&&!(e>64&&e<91)&&!(e>96&&e<123)&&e!==95)return`⟨${r.replaceAll("⟩","\\⟩")}⟩`;return r}function Ir(r){return le(r)}function lr(r){return r<=cr?r.toString():`⟨${r}⟩`}function hr(r){return/^\d+$/.test(r.replace(/_/g,""))}var A=class L extends m{constructor(t){super();a(this,"inner");t instanceof ArrayBuffer?this.inner=b.ofInner(new Uint8Array(t)):t instanceof Uint8Array?this.inner=b.ofInner(t):t instanceof L?this.inner=t.inner:t instanceof b?this.inner=t:this.inner=b.parse(t)}equals(t){return t instanceof L?this.inner.equals(t.inner):!1}toString(){return this.inner.toString()}toJSON(){return this.inner.toString()}toUint8Array(){return this.inner.bytes}toBuffer(){return this.inner.bytes.buffer}static v4(){return new L(Vt())}static v7(){return new L(Bt())}},M=class vt extends m{constructor(t,n){super();a(this,"tb");a(this,"id");if(typeof t!="string")throw new u("TB part is not valid");if(!Et(n))throw new u("ID part is not valid");this.tb=t,this.id=n}equals(t){return t instanceof vt?this.tb===t.tb&&k(this.id,t.id):!1}toJSON(){return this.toString()}toString(){let t=le(this.tb),n=St(this.id);return`${t}:${n}`}},B=class _e extends m{constructor(t){super();a(this,"rid");if(t instanceof _e)this.rid=t.rid;else if(t instanceof M)this.rid=t.toString();else if(typeof t=="string")this.rid=t;else throw new u("String Record ID must be a string")}equals(t){return t instanceof _e?this.rid===t.rid:!1}toJSON(){return this.rid}toString(){return this.rid}};function Et(r){if(r instanceof A)return!0;switch(typeof r){case"string":case"number":case"bigint":return!0;case"object":return Array.isArray(r)||r!==null;default:return!1}}function St(r){return r instanceof A?`u"${r}"`:typeof r=="string"?le(r):typeof r=="bigint"||typeof r=="number"?lr(r):S(r)}var x=class At extends m{constructor(t){super();a(this,"tb");if(typeof t!="string")throw new u("Table must be a string");this.tb=t}equals(t){return t instanceof At?this.tb===t.tb:!1}toJSON(){return this.tb}toString(){return this.tb}};function S(r){if(typeof r=="string")return`s${JSON.stringify(r)}`;if(r===null)return"NULL";if(r===void 0)return"NONE";if(typeof r=="object"){if(r instanceof Date)return`d${JSON.stringify(r.toISOString())}`;if(r instanceof A)return`u${JSON.stringify(r.toString())}`;if(r instanceof M||r instanceof B)return`r${JSON.stringify(r.toString())}`;if(r instanceof v)return S(r.toJSON());if(r instanceof P||r instanceof $||r instanceof oe||r instanceof C||r instanceof x)return r.toJSON();switch(Object.getPrototypeOf(r)){case Object.prototype:{let e="{ ",t=Object.entries(r);for(let[n,[s,o]]of t.entries())e+=`${JSON.stringify(s)}: ${S(o)}`,n<t.length-1&&(e+=", ");return e+=" }",e}case Map.prototype:{let e="{ ",t=Array.from(r.entries());for(let[n,[s,o]]of t.entries())e+=`${JSON.stringify(s)}: ${S(o)}`,n<t.length-1&&(e+=", ");return e+=" }",e}case Array.prototype:return`[ ${r.map(S).join(", ")} ]`;case Set.prototype:return`[ ${[...new Set([...r].map(S))].join(", ")} ]`}}return`${r}`}var C=class xt extends m{constructor(e,t){super(),this.beg=e,this.end=t}equals(e){var t,n,s,o,i,c,l,h;return!(e instanceof xt)||((t=this.beg)==null?void 0:t.constructor)!==((n=e.beg)==null?void 0:n.constructor)||((s=this.end)==null?void 0:s.constructor)!==((o=e.end)==null?void 0:o.constructor)?!1:k((i=this.beg)==null?void 0:i.value,(c=e.beg)==null?void 0:c.value)&&k((l=this.end)==null?void 0:l.value,(h=e.end)==null?void 0:h.value)}toJSON(){return this.toString()}toString(){let e=Ye(this.beg),t=Ye(this.end);return`${e}${Ut(this.beg,this.end)}${t}`}},I=class{constructor(r){this.value=r}},j=class{constructor(r){this.value=r}},ve=class Rt extends m{constructor(e,t,n){if(super(),this.tb=e,this.beg=t,this.end=n,typeof e!="string")throw new u("TB part is not valid");if(!We(t))throw new u("Beg part is not valid");if(!We(n))throw new u("End part is not valid")}equals(e){var t,n,s,o,i,c,l,h;return!(e instanceof Rt)||((t=this.beg)==null?void 0:t.constructor)!==((n=e.beg)==null?void 0:n.constructor)||((s=this.end)==null?void 0:s.constructor)!==((o=e.end)==null?void 0:o.constructor)?!1:this.tb===e.tb&&k((i=this.beg)==null?void 0:i.value,(c=e.beg)==null?void 0:c.value)&&k((l=this.end)==null?void 0:l.value,(h=e.end)==null?void 0:h.value)}toJSON(){return this.toString()}toString(){let e=le(this.tb),t=qe(this.beg),n=qe(this.end);return`${e}:${t}${Ut(this.beg,this.end)}${n}`}};function Ut(r,e){let t="";return r instanceof j&&(t+=">"),t+="..",e instanceof I&&(t+="="),t}function We(r){return r instanceof I||r instanceof j?Et(r.value):!0}function qe(r){return r instanceof I||r instanceof j?St(r.value):""}function Ye(r){if(r===void 0)return"";let e=r.value;return r instanceof C?`(${S(e)})`:S(e)}function Xe([r,e]){function t(n){return n instanceof I?new f(Nt,n.value):n instanceof j?new f(Ot,n.value):null}return[t(r),t(e)]}function ur(r){function e(t){if(t!==null){if(t instanceof I||t instanceof j)return t;throw new u("Expected the bounds to be decoded already")}}return[e(r[0]),e(r[1])]}var dr=0,Ke=37,ze=6,Qe=7,F=8,fr=9,Ze=10,He=12,pr=13,et=14,tt=15,he=49,Nt=50,Ot=51,rt=88,nt=89,st=90,it=91,ot=92,at=93,ct=94,D={encode(r){return r instanceof Date?new f(He,sr(r)):r===void 0?new f(ze,null):r instanceof A?new f(Ke,r.toBuffer()):r instanceof P?new f(Ze,r.toString()):r instanceof $?new f(et,r.toCompact()):r instanceof M?new f(F,[r.tb,r.id]):r instanceof B?new f(F,r.rid):r instanceof ve?new f(F,[r.tb,new f(he,Xe([r.beg,r.end]))]):r instanceof x?new f(Qe,r.tb):r instanceof oe?new f(tt,r.inner):r instanceof C?new f(he,Xe([r.beg,r.end])):r instanceof $e?new f(rt,r.point):r instanceof Pe?new f(nt,r.line):r instanceof Ge?new f(st,r.polygon):r instanceof Be?new f(it,r.points):r instanceof Ve?new f(ot,r.lines):r instanceof Fe?new f(at,r.polygons):r instanceof Je?new f(ct,r.collection):r},decode(r){if(!(r instanceof f))return r;switch(r.tag){case dr:return new Date(r.value);case Ke:case fr:return new A(r.value);case He:return ir(r.value);case ze:return;case Ze:return new P(r.value);case pr:return new $(r.value);case et:return $.fromCompact(r.value);case Qe:return new x(r.value);case tt:return new oe(r.value);case he:return new C(...ur(r.value));case Nt:return new I(r.value);case Ot:return new j(r.value);case F:return r.value[1]instanceof C?new ve(r.value[0],r.value[1].beg,r.value[1].end):new M(r.value[0],r.value[1]);case rt:return new $e(r.value);case nt:return new Pe(r.value);case st:return new Ge(r.value);case it:return new Be(r.value);case ot:return new Ve(r.value);case at:return new Fe(r.value);case ct:return new Je(r.value)}}};Object.freeze(D);function wr(r){return T(r,{replacer:D.encode})}function mr(r){return bt(r,{replacer:D.decode})}var J,Ct=class{constructor(r,e){a(this,"_query");a(this,"_bindings");a(this,"length");J??(J=new TextEncoder),this._query=J.encode(r),this._bindings=Ae(e??{},{replacer:D.encode}),this.length=Object.keys(this._bindings).length}get query(){let r=new G(this._query.byteLength+9);return r.writeMajor(3,this._query.byteLength),r.writeUint8Array(this._query),new Ee(r.output(!1))}get bindings(){return this._bindings}build(r){return T([this.query,this.bindings],{fills:r})}append(r,...e){let t=this.length;this.length+=e.length;let n=0,s=new Map,o=e.map((h,p)=>{if(h instanceof ae){let _=s.get(h);if(_!==void 0)return n++,[`bind___${_}`,h];s.set(h,p-n)}return[`bind___${t+p-n}`,h]});for(let[h,p]of o)this._bindings[h]=T(p,{replacer:D.encode,partial:!0});let i=r.flatMap((h,p)=>{var U;let _=(U=o[p])==null?void 0:U[0];return[h,..._?[`$${_}`]:[]]}).join("");J??(J=new TextEncoder);let c=new Uint8Array(this._query),l=J.encode(i);return this._query=new Uint8Array(c.byteLength+l.byteLength),this._query.set(c),this._query.set(l,c.byteLength),this}};function jr(r,...e){let t=0,n=new Map,s=e.map((c,l)=>{if(c instanceof ae){let h=n.get(c);if(h!==void 0)return t++,[`bind___${h}`,c];n.set(c,l-t)}return[`bind___${l-t}`,c]}),o=s.reduce((c,[l,h])=>(c[l]=h,c),{}),i=r.flatMap((c,l)=>{var p;let h=(p=s[l])==null?void 0:p[0];return[c,...h?[`$${h}`]:[]]}).join("");return new Ct(i,o)}function lt(r){let e={},t=(n,s,o)=>{if(n in r)e[s]=`${r[n]}`,delete e[n];else if(o!==!0)throw new u(`Key ${n} is missing from the authentication parameters`)};return"scope"in r?(e={...r},t("scope","sc"),t("namespace","ns"),t("database","db")):"variables"in r?(e={...r.variables},t("access","ac"),t("namespace","ns"),t("database","db")):(t("access","ac",!0),t("database","db",!0),t("namespace","ns",!("database"in r)),t("username","user"),t("password","pass")),e}var br=["CREATE","UPDATE","DELETE"];function gr(r){return!(typeof r!="object"||r===null||!("id"in r&&"action"in r&&"result"in r)||!(r.id instanceof A)||!br.includes(r.action)||typeof r.result!="object"||r.result===null)}var ue={enabled:!0,attempts:5,retryDelay:1e3,retryDelayMax:6e4,retryDelayMultiplier:2,retryDelayJitter:.1};function W(r){if(typeof r=="object"){if(r===null)return null;if(r instanceof Date||r instanceof A||r instanceof P||r instanceof $||r instanceof oe||r instanceof C||r instanceof B||r instanceof ve||r instanceof M||r instanceof v||r instanceof x)return r.toJSON();switch(Object.getPrototypeOf(r)){case Object.prototype:{let e=Object.entries(r).map(([t,n])=>[t,W(n)]).filter(([t,n])=>n!==void 0);return Object.fromEntries(e)}case Map.prototype:{let e=Array.from(r).map(([t,n])=>[t,W(n)]).filter(([t,n])=>n!==void 0);return new Map(e)}case Array.prototype:return r.map(W);case Set.prototype:return new Set([...r].map(W))}}return r}var yr=5e3,Ue="1.4.2",Ne="3.0.0",Lr=`>= ${Ue} < ${Ne}`;function _r(r,e=Ue,t=Ne){if(!vr(r,e,t))throw new nr(r,`>= ${e} < ${t}`);return!0}function vr(r,e=Ue,t=Ne){return e.localeCompare(r,void 0,{numeric:!0})<=0&&t.localeCompare(r,void 0,{numeric:!0})===1}async function Tt(r,e){let t={"ws:":"http:","wss:":"https:","http:":"http:","https:":"https:"}[r.protocol];if(t){let n=r.pathname.slice(0,-4);r=new URL(r),r.pathname=`${n}/version`,r.protocol=t;let s=new AbortController,o=setTimeout(()=>s.abort(),e??yr),i="surrealdb-";return await fetch(r,{signal:s.signal}).then(c=>c.text()).then(c=>c.slice(i.length)).catch(c=>{throw new De(c)}).finally(()=>{clearTimeout(o)})}throw new De}var de=0;function kt(){return de=(de+1)%Number.MAX_SAFE_INTEGER,de.toString()}function Oe(r,...e){return r.reduce((t,n,s)=>`${t}${n}${e[s]??""}`,"")}function $r(r,...e){return new Date(Oe(r,e))}function Pr(r,...e){return new B(Oe(r,e))}function Gr(r,...e){return new A(Oe(r,e))}var ht=Symbol("RetryMessage"),Er=(r=>(r.Disconnected="disconnected",r.Connecting="connecting",r.Reconnecting="reconnecting",r.Connected="connected",r.Error="error",r))(Er||{}),Sr=class{constructor({emitter:r,encodeCbor:e,decodeCbor:t,reconnect:n,prepare:s}){a(this,"emitter");a(this,"encodeCbor");a(this,"decodeCbor");a(this,"reconnect");a(this,"prepare");this.emitter=r,this.encodeCbor=e,this.decodeCbor=t,this.reconnect=n,this.prepare=s}},Ar=class{constructor(r){a(this,"context");a(this,"ready");a(this,"status","disconnected");a(this,"connection",{url:void 0,namespace:void 0,database:void 0,token:void 0});this.context=r}get emitter(){return this.context.emitter}get encodeCbor(){return this.context.encodeCbor}get decodeCbor(){return this.context.decodeCbor}};function ut(r,e){if("scope"in r||"access"in r&&"variables"in r&&r.variables){if(!r.namespace){if(!(e!=null&&e.namespace))throw new tr;r.namespace=e.namespace}if(!r.database){if(!(e!=null&&e.database))throw new rr;r.database=e.database}}return r}var Mt=class{async signup(r){if(!this.connection)throw new y;let e=ut(r,this.connection.connection),t=lt(e),n=await this.rpc("signup",[t]);if(n.error)throw new d(n.error.message);if(!n.result)throw new Me;return n.result}async signin(r){if(!this.connection)throw new y;let e=ut(r,this.connection.connection),t=lt(e),n=await this.rpc("signin",[t]);if(n.error)throw new d(n.error.message);if(!n.result)throw new Me;return n.result}async authenticate(r){let e=await this.rpc("authenticate",[r]);if(e.error)throw new d(e.error.message);return!0}async invalidate(){let r=await this.rpc("invalidate");if(r.error)throw new d(r.error.message);return!0}},Dt=class extends Mt{constructor(r){super(),this.connection=r}rpc(r,e){if(!this.connection)throw new y;return this.connection.rpc({method:r,params:e},!0)}},It=class extends Ar{async req_post(r,e,t){let n={"Content-Type":"application/cbor",Accept:"application/cbor",...t};this.connection.namespace&&(n["Surreal-NS"]=this.connection.namespace),this.connection.database&&(n["Surreal-DB"]=this.connection.database),this.connection.token&&(n.Authorization=`Bearer ${this.connection.token}`);let s=await fetch(`${e??this.connection.url}`,{method:"POST",headers:n,body:this.encodeCbor(r)}),o=await s.arrayBuffer();if(s.status===200)return o;let i=new TextDecoder("utf-8");throw new er(i.decode(o),s.status,s.statusText,o)}},xr=new Set(["signin","signup","authenticate","invalidate","version","use","let","unset","query"]),dt=class extends It{constructor(){super(...arguments);a(this,"connection",{url:void 0,namespace:void 0,database:void 0,token:void 0,variables:{}})}setStatus(e,...t){this.status=e,this.emitter.emit(e,t)}version(e,t){return Tt(e,t)}async connect(e){var t,n;return this.setStatus("connecting"),this.connection.url=e,await((n=(t=this.context).prepare)==null?void 0:n.call(t,new Dt(this))),this.setStatus("connected"),this.ready=new Promise(s=>s()),this.ready}disconnect(){return this.connection={url:void 0,namespace:void 0,database:void 0,token:void 0,variables:{}},this.ready=void 0,this.setStatus("disconnected"),new Promise(e=>e())}async rpc(e,t){var i,c;if(t||await this.ready,!this.connection.url)throw new N;if((!this.connection.namespace||!this.connection.database)&&!xr.has(e.method))throw new Ht;if(e.method==="use"){let[l,h]=e.params;return l===null&&(this.connection.namespace=void 0),h===null&&(this.connection.database=void 0),l&&(this.connection.namespace=l),h&&(this.connection.database=h),{result:!0}}if(e.method==="let"){let[l,h]=e.params;return this.connection.variables[l]=h,{result:!0}}if(e.method==="unset"){let[l]=e.params;return delete this.connection.variables[l],{result:!0}}e.method==="query"&&(e.params=[(i=e.params)==null?void 0:i[0],{...this.connection.variables,...((c=e.params)==null?void 0:c[1])??{}}]);let n=kt(),s=await this.req_post({id:n,...e}),o=this.decodeCbor(s);if("result"in o)switch(e.method){case"signin":case"signup":{this.connection.token=o.result;break}case"authenticate":{let[l]=e.params;this.connection.token=l;break}case"invalidate":{this.connection.token=void 0;break}}return this.emitter.emit(`rpc-${n}`,[o]),o}get connected(){return!!this.connection.url}async export(e){if(!this.connection.url)throw new N;let t=new URL(this.connection.url),n=t.pathname.slice(0,-4);t.pathname=`${n}/export`;let s=await this.req_post(e??{},t,{Accept:"plain/text"});return new TextDecoder("utf-8").decode(s)}async import(e){if(!this.connection.url)throw new N;let t=new URL(this.connection.url),n=t.pathname.slice(0,-4);t.pathname=`${n}/import`,await this.req_post(e,t,{Accept:"application/json"})}};function q(){let r={completed:!1};return r.promise=new Promise((e,t)=>{r.resolve=n=>{r.completed=!0,e(n)},r.reject=n=>{r.completed=!0,t(n)}}),r}var ft=class extends It{constructor(e){super(e);a(this,"pinger");a(this,"socket");a(this,"disconnected");this.disconnected=q()}setStatus(e,...t){this.connection.url&&e==="disconnected"||e==="error"?(this.disconnected.resolve(),this.disconnected=q()):(this.status=e,this.emitter.emit(e,t))}async requireStatus(e){return this.status!==e&&await this.emitter.subscribeOnce(e),!0}version(e,t){return Tt(e,t)}async connect(e){this.connection.url=e,(async()=>{let t=!0,n;for(;this.connection.url;)if(t)t=!1,this.setStatus("connecting"),this.ready=this.createSocket(),await this.disconnected.promise;else{if(!this.context.reconnect.enabled)break;if(!n){let{promise:i,resolve:c,reject:l}=q();this.ready=i,n=[c,l]}let[s,o]=n;if(!this.context.reconnect.allowed){this.connection={url:void 0,namespace:void 0,database:void 0,token:void 0},this.socket=void 0,o(new Te),this.emitter.emit("error",[new Te]),this.setStatus("disconnected");break}this.setStatus("reconnecting"),await this.context.reconnect.iterate();try{await this.createSocket()}catch{continue}try{if(this.connection.namespace||this.connection.database){let i=await this.rpc({method:"use",params:[this.connection.namespace,this.connection.database]},!0);if(i.error)throw new d(i.error.message)}if(this.connection.token){let i=await this.rpc({method:"authenticate",params:[this.connection.token]},!0);if(i.error)throw new d(i.error.message)}}catch(i){this.connection={url:void 0,namespace:void 0,database:void 0,token:void 0},this.socket=void 0,o(i),this.emitter.emit("error",[i]),this.setStatus("disconnected");break}this.context.reconnect.reset(),s(),this.emitter.scanListeners(i=>i.startsWith("rpc-")).map(i=>this.emitter.emit(i,[ht])),this.status==="connected"&&await this.disconnected.promise}})(),await this.ready}async createSocket(){let{promise:e,resolve:t,reject:n}=q();if(!this.connection.url)throw new Kt;let s=new Ce(this.connection.url.toString(),"cbor");s.addEventListener("open",async()=>{var o,i,c;this.socket=s,await((i=(o=this.context).prepare)==null?void 0:i.call(o,new Dt(this))),this.setStatus("connected"),(c=this.pinger)==null||c.stop(),this.pinger=new Rr(3e4),this.pinger.start(()=>{try{this.rpc({method:"ping"})}catch{}}),t()}),s.addEventListener("error",o=>{let i=new Qt("detail"in o&&o.detail?o.detail:"message"in o&&o.message?o.message:"error"in o&&o.error?o.error:"An unexpected error occurred");this.setStatus("error",i),n(i)}),s.addEventListener("close",()=>{var o;this.setStatus("disconnected"),(o=this.pinger)==null||o.stop()}),s.addEventListener("message",async({data:o})=>{try{let i=this.decodeCbor(o instanceof ArrayBuffer?o:o instanceof Blob?await o.arrayBuffer():o.buffer.slice(o.byteOffset,o.byteOffset+o.byteLength));if(typeof i=="object"&&i!=null&&Object.getPrototypeOf(i)===Object.prototype)this.handleRpcResponse(i);else throw new ke(i)}catch(i){s.dispatchEvent(new CustomEvent("error",{detail:i}))}}),await e}async disconnect(){var e,t;this.connection={url:void 0,namespace:void 0,database:void 0,token:void 0},await((e=this.ready)==null?void 0:e.catch(()=>{})),(t=this.socket)==null||t.close(),this.ready=void 0,this.socket=void 0,this.disconnected.resolve(),await Promise.any([this.requireStatus("disconnected"),this.requireStatus("error")])}async rpc(e,t){if(t||await this.ready,!this.socket)throw new N;let n;for(;!n;){let s=kt(),o=this.emitter.subscribeOnce(`rpc-${s}`);if(this.socket.send(this.encodeCbor({id:s,...e})),t&&this.socket.readyState===Ce.CLOSED)throw new pe;let[i]=await o;if(i instanceof pe)throw i;i!==ht&&(n=i)}if("result"in n)switch(e.method){case"use":{let[s,o]=e.params;s===null&&(this.connection.namespace=void 0),o===null&&(this.connection.database=void 0),s&&(this.connection.namespace=s),o&&(this.connection.database=o);break}case"signin":case"signup":{this.connection.token=n.result;break}case"authenticate":{let[s]=e.params;this.connection.token=s;break}case"invalidate":{this.connection.token=void 0;break}}return n}handleRpcResponse({id:e,...t}){if(e)this.emitter.emit(`rpc-${e}`,[t]);else if(t.error)this.setStatus("error",new d(t.error));else if(gr(t.result)){let{id:n,action:s,result:o}=t.result;this.emitter.emit(`live-${n}`,[s,o],!0)}else this.setStatus("error",new ke({id:e,...t}))}get connected(){return!!this.socket}async export(e){if(!this.connection.url)throw new N;let t=new URL(this.connection.url),n=t.pathname.slice(0,-4);t.protocol=t.protocol.replace("ws","http"),t.pathname=`${n}/export`;let s=await this.req_post(e??{},t,{Accept:"plain/text"});return new TextDecoder("utf-8").decode(s)}async import(e){if(!this.connection.url)throw new N;let t=new URL(this.connection.url),n=t.pathname.slice(0,-4);t.protocol=t.protocol.replace("ws","http"),t.pathname=`${n}/import`,await this.req_post(e,t,{Accept:"application/json"})}},Rr=class{constructor(r=3e4){a(this,"pinger");a(this,"interval");this.interval=r}start(r){this.pinger=setInterval(r,this.interval)}stop(){clearInterval(this.pinger)}};function Ur(r,e){return Math.random()*(e-r)+r}var Nr=class{constructor(r,e){a(this,"_attempts",0);a(this,"options");a(this,"surreal");this.surreal=e,r?r===!0?this.options=ue:this.options={...ue,...r}:this.options={...ue,enabled:!1}}get attempts(){return this._attempts}get enabled(){return this.options.enabled}get allowed(){return!(!this.options.enabled||this.options.attempts!==-1&&this._attempts>=this.options.attempts)}reset(){this._attempts=0}async iterate(){if(!this.allowed)throw new zt;this._attempts++;let r=this.options.retryDelayMultiplier**this.attempts,e=this.options.retryDelay*r,t=Ur(-this.options.retryDelayJitter,this.options.retryDelayJitter),n=Math.min(e*(1+t),this.options.retryDelayMax);await new Promise(s=>setTimeout(s,n))}},Br=class extends Mt{constructor({engines:e}={}){super();a(this,"connection");a(this,"emitter");a(this,"engines",{ws:ft,wss:ft,http:dt,https:dt});a(this,"_ready");this.emitter=new qt,e&&(this.engines={...this.engines,...e})}async connect(e,t={}){return this._ready=this.connectInner(e,t),await this._ready,!0}async connectInner(e,t={}){let n=Or(e),s=n.protocol.slice(0,-1),o=this.engines[s];if(!o)throw new Zt(s);let{prepare:i,auth:c,namespace:l,database:h,reconnect:p}=t;await this.close();let _=new Sr({emitter:this.emitter,encodeCbor:wr,decodeCbor:mr,reconnect:new Nr(p,this),prepare:i}),U=new o(_);if(t.versionCheck!==!1){let jt=await U.version(n,t.versionCheckTimeout);_r(jt)}this.connection=U,await U.connect(n),(l||h)&&await this.use({namespace:l,database:h}),typeof c=="string"?await this.authenticate(c):c&&await this.signin(c)}async close(){var e;return this.clean(),await((e=this.connection)==null?void 0:e.disconnect()),!0}clean(){let e=this.emitter.scanListeners(n=>n.startsWith("rpc-"));e.map(n=>this.emitter.emit(n,[new pe]));let t=this.emitter.scanListeners(n=>n.startsWith("live-"));t.map(n=>this.emitter.emit(n,["CLOSE","disconnected"])),this.emitter.reset({collectable:!0,listeners:[...e,...t]})}get status(){var e;return((e=this.connection)==null?void 0:e.status)??"disconnected"}get ready(){var e;return Promise.all([this._ready,(e=this.connection)==null?void 0:e.ready]).then(()=>{})}async ping(){let{error:e}=await this.rpc("ping");if(e)throw new d(e.message);return!0}async use({namespace:e,database:t}){if(!this.connection)throw new y;if(e===null&&t!==null)throw new u("Cannot unset namespace without unsetting database");let{error:n}=await this.rpc("use",[e,t]);if(n)throw new d(n.message);return!0}async info(){await this.ready;let e=await this.rpc("info");if(e.error)throw new d(e.error.message);return e.result??void 0}async let(e,t){let n=await this.rpc("let",[e,t]);if(n.error)throw new d(n.error.message);return!0}async unset(e){let t=await this.rpc("unset",[e]);if(t.error)throw new d(t.error.message);return!0}async live(e,t,n){await this.ready;let s=await this.rpc("live",[e,n]);if(s.error)throw new d(s.error.message);return t&&this.subscribeLive(s.result,t),s.result}async subscribeLive(e,t){if(await this.ready,!this.connection)throw new y;this.connection.emitter.subscribe(`live-${e}`,t,!0)}async unSubscribeLive(e,t){if(await this.ready,!this.connection)throw new y;this.connection.emitter.unSubscribe(`live-${e}`,t)}async kill(e){if(await this.ready,!this.connection)throw new y;if(Array.isArray(e)){await Promise.all(e.map(n=>this.rpc("kill",[n])));let t=e.map(n=>`live-${n}`);t.map(n=>this.emitter.emit(n,["CLOSE","killed"])),this.connection.emitter.reset({collectable:t,listeners:t})}else await this.rpc("kill",[e]),this.emitter.emit(`live-${e}`,["CLOSE","killed"]),this.connection.emitter.reset({collectable:`live-${e}`,listeners:`live-${e}`})}async query(...e){return(await this.queryRaw(...e)).map(({status:t,result:n})=>{if(t==="ERR")throw new d(n);return n})}async queryRaw(...[e,t]){let n=e instanceof Ct?[e.query,Ae(e.bindings,{fills:t,replacer:D.encode})]:[e,t];await this.ready;let s=await this.rpc("query",n);if(s.error)throw new d(s.error.message);return s.result}async query_raw(...e){return this.queryRaw(...e)}async select(e){await this.ready;let t=await this.rpc("select",[e]);if(t.error)throw new d(t.error.message);return E(e,t.result)}async create(e,t){await this.ready;let n=await this.rpc("create",[e,t]);if(n.error)throw new d(n.error.message);return E(e,n.result)}async insert(e,t){await this.ready;let[n,s]=typeof e=="string"||e instanceof x?[e,t]:[void 0,e],o=await this.rpc("insert",[n,s]);if(o.error)throw new d(o.error.message);return o.result}async insertRelation(e,t){await this.ready;let[n,s]=typeof e=="string"||e instanceof x?[e,t]:[void 0,e],o=await this.rpc("insert_relation",[n,s]);if(o.error)throw new d(o.error.message);return o.result}async insert_relation(e,t){return e instanceof x||typeof e=="string"?this.insertRelation(e,t):this.insertRelation(e)}async update(e,t){await this.ready;let n=await this.rpc("update",[e,t]);if(n.error)throw new d(n.error.message);return E(e,n.result)}async upsert(e,t){await this.ready;let n=await this.rpc("upsert",[e,t]);if(n.error)throw new d(n.error.message);return E(e,n.result)}async merge(e,t){await this.ready;let n=await this.rpc("merge",[e,t]);if(n.error)throw new d(n.error.message);return E(e,n.result)}async patch(e,t,n){await this.ready;let s=await this.rpc("patch",[e,t,n]);if(s.error)throw new d(s.error.message);return n?s.result:E(e,s.result)}async delete(e){await this.ready;let t=await this.rpc("delete",[e]);if(t.error)throw new d(t.error.message);return E(e,t.result)}async version(){await this.ready;let e=await this.rpc("version");if(e.error)throw new d(e.error.message);return e.result}async run(e,t,n){await this.ready;let[s,o]=Array.isArray(t)?[void 0,t]:[t,n],i=await this.rpc("run",[e,s,o]);if(i.error)throw new d(i.error.message);return i.result}async relate(e,t,n,s){await this.ready;let o=await this.rpc("relate",[e,t,n,s]);if(o.error)throw new d(o.error.message);return E(t,o.result)}rpc(e,t){if(!this.connection)throw new y;return this.connection.rpc({method:e,params:t})}async export(e){if(await this.ready,!this.connection)throw new y;return this.connection.export(e)}async import(e){if(await this.ready,!this.connection)throw new y;return this.connection.import(e)}};function E(r,e){return r instanceof M||r instanceof B?Array.isArray(e)?e[0]:e:Array.isArray(e)?e:[e]}function Or(r){let e=new URL(r);return e.pathname.endsWith("/rpc")||(e.pathname.endsWith("/")||(e.pathname+="/"),e.pathname+="rpc"),e}export{Ar as AbstractEngine,Mt as AuthController,j as BoundExcluded,I as BoundIncluded,Y as CborBreak,R as CborError,mt as CborFillMissing,ce as CborInvalidMajorError,we as CborNumberError,wt as CborPartialDisabled,g as CborRangeError,Er as ConnectionStatus,N as ConnectionUnavailable,ue as DEFAULT_RECONNECT_OPTIONS,P as Decimal,$ as Duration,qt as Emitter,Dt as EngineAuth,pe as EngineDisconnected,Dr as FeatureUnavailableForEngine,oe as Future,ae as Gap,v as Geometry,Je as GeometryCollection,Pe as GeometryLine,Ve as GeometryMultiLine,Be as GeometryMultiPoint,Fe as GeometryMultiPolygon,$e as GeometryPoint,Ge as GeometryPolygon,er as HttpConnectionError,Mr as InvalidURLProvided,Ht as MissingNamespaceDatabase,y as NoActiveSocket,Tr as NoConnectionDetails,rr as NoDatabaseSpecified,tr as NoNamespaceSpecified,Me as NoTokenReturned,Kt as NoURLProvided,Ct as PreparedQuery,C as Range,Te as ReconnectFailed,zt as ReconnectIterationError,M as RecordId,ve as RecordIdRange,d as ResponseError,B as StringRecordId,Br as Surreal,u as SurrealDbError,x as Table,Qt as UnexpectedConnectionError,kr as UnexpectedResponse,ke as UnexpectedServerResponse,Zt as UnsupportedEngine,nr as UnsupportedVersion,A as Uuid,De as VersionRetrievalFailure,Yt as cbor,lt as convertAuth,$r as d,mr as decodeCbor,Br as default,yr as defaultVersionCheckTimeout,wr as encodeCbor,k as equals,le as escapeIdent,lr as escapeNumber,Ir as escape_ident,kt as getIncrementalID,gr as isLiveResult,vr as isVersionSupported,W as jsonify,br as liveActions,Pr as r,Tt as retrieveRemoteVersion,Oe as s,Ue as supportedSurrealDbVersionMin,Lr as supportedSurrealDbVersionRange,Ne as supportedSurrealDbVersionUntil,jr as surql,jr as surrealql,S as toSurrealqlString,Gr as u,_r as versionCheck};
