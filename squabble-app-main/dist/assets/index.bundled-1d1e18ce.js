var $t=Object.defineProperty;var Gt=(t,r,e)=>r in t?$t(t,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[r]=e;var a=(t,r,e)=>(Gt(t,typeof r!="symbol"?r+"":r,e),e);var Pt=Object.defineProperty,Bt=(t,r)=>{for(var e in r)Pt(t,e,{get:r[e],enumerable:!0})},Vt=class{constructor({interceptors:t}={}){a(this,"collectable",{});a(this,"listeners",{});a(this,"interceptors");this.interceptors=t??{}}subscribe(t,r,e=!1){var n;if(this.listeners[t]||(this.listeners[t]=[]),!this.isSubscribed(t,r)&&((n=this.listeners[t])==null||n.push(r),e&&this.collectable[t])){let i=this.collectable[t];delete this.collectable[t];for(let o of i)r(...o)}}async subscribeOnce(t,r=!1){var e,n;if(r&&this.collectable[t]){let i=(e=this.collectable[t])==null?void 0:e.shift();if(((n=this.collectable[t])==null?void 0:n.length)===0&&delete this.collectable[t],i)return i}return new Promise(i=>{let o=!1,s=(...c)=>{o||(o=!0,this.unSubscribe(t,s),i(c))};this.subscribe(t,s,!1)})}unSubscribe(t,r){var e,n,i;if(this.listeners[t]){let o=(e=this.listeners[t])==null?void 0:e.findIndex(s=>s===r);o>=0&&((n=this.listeners[t])==null||n.splice(o,1),((i=this.listeners[t])==null?void 0:i.length)===0&&delete this.listeners[t])}}isSubscribed(t,r){var e;return!!((e=this.listeners[t])!=null&&e.includes(r))}async emit(t,r,e=!1){var o,s;let n=this.interceptors[t],i=n?await n(...r):r;(e&&!this.listeners[t]||((o=this.listeners[t])==null?void 0:o.length)===0)&&(this.collectable[t]||(this.collectable[t]=[]),(s=this.collectable[t])==null||s.push(r));for(let c of this.listeners[t]??[])c(...i)}reset({collectable:t,listeners:r}){if(Array.isArray(t))for(let e of t)delete this.collectable[e];else typeof t=="string"?delete this.collectable[t]:t!==!1&&(this.collectable={});if(Array.isArray(r))for(let e of r)delete this.listeners[e];else typeof r=="string"?delete this.listeners[r]:r!==!1&&(this.listeners={})}scanListeners(t){let r=Object.keys(this.listeners);return t&&(r=r.filter(t)),r}},ce=class{constructor(...t){a(this,"args",[]);this.args=t}fill(t){return[this,t]}hasDefault(){return this.args.length===1}get default(){return this.args[0]}},Ft={};Bt(Ft,{CborBreak:()=>K,CborError:()=>U,CborFillMissing:()=>mt,CborInvalidMajorError:()=>le,CborNumberError:()=>me,CborPartialDisabled:()=>wt,CborRangeError:()=>g,Encoded:()=>Ee,Gap:()=>ce,POW_2_53:()=>Jt,POW_2_64:()=>pe,PartiallyEncoded:()=>Ae,Reader:()=>ge,Tagged:()=>f,Writer:()=>B,decode:()=>gt,encode:()=>k,infiniteBytes:()=>be,partiallyEncodeObject:()=>Ue});var Jt=9007199254740992,pe=BigInt(18446744073709552e3),Ee=class{constructor(t){this.encoded=t}},u=class extends Error{},b=class extends u{constructor(){super(...arguments);a(this,"name","NoActiveSocket");a(this,"message","No socket is currently connected to a SurrealDB instance. Please call the .connect() method first!")}},Tr=class extends u{constructor(){super(...arguments);a(this,"name","NoConnectionDetails");a(this,"message","No connection details for the HTTP api have been provided. Please call the .connect() method first!")}},Dr=class extends u{constructor(){super(...arguments);a(this,"name","UnexpectedResponse");a(this,"message","The returned response from the SurrealDB instance is in an unexpected format. Unable to process response!")}},Mr=class extends u{constructor(){super(...arguments);a(this,"name","InvalidURLProvided");a(this,"message","The provided string is either not a URL or is a URL but with an invalid protocol!")}},Wt=class extends u{constructor(){super(...arguments);a(this,"name","NoURLProvided");a(this,"message","Tried to establish a connection while no connection URL was provided")}},we=class extends u{constructor(){super(...arguments);a(this,"name","EngineDisconnected");a(this,"message","The engine reported the connection to SurrealDB has dropped")}},ke=class extends u{constructor(){super(...arguments);a(this,"name","ReconnectFailed");a(this,"message","The engine failed to reconnect to SurrealDB")}},qt=class extends u{constructor(){super(...arguments);a(this,"name","ReconnectIterationError");a(this,"message","The reconnect iterator failed to iterate")}},Te=class extends u{constructor(r){super();a(this,"name","UnexpectedServerResponse");this.response=r,this.message=`${r}`}},Yt=class extends u{constructor(r){super();a(this,"name","UnexpectedConnectionError");this.error=r,this.message=`${r}`}},Kt=class extends u{constructor(r){super();a(this,"name","UnsupportedEngine");a(this,"message","The engine you are trying to connect to is not supported or configured.");this.engine=r}},Ir=class extends u{constructor(){super(...arguments);a(this,"name","FeatureUnavailableForEngine");a(this,"message","The feature you are trying to use is not available on this engine.")}},N=class extends u{constructor(){super(...arguments);a(this,"name","ConnectionUnavailable");a(this,"message","There is no connection available at this moment.")}},Xt=class extends u{constructor(){super(...arguments);a(this,"name","MissingNamespaceDatabase");a(this,"message","There is no namespace and/or database selected.")}},zt=class extends u{constructor(r,e,n,i){super();a(this,"name","HttpConnectionError");this.message=r,this.status=e,this.statusText=n,this.buffer=i}},d=class extends u{constructor(r){super();a(this,"name","ResponseError");this.message=r}},Qt=class extends u{constructor(){super(...arguments);a(this,"name","NoNamespaceSpecified");a(this,"message","Please specify a namespace to use.")}},Zt=class extends u{constructor(){super(...arguments);a(this,"name","NoDatabaseSpecified");a(this,"message","Please specify a database to use.")}},De=class extends u{constructor(){super(...arguments);a(this,"name","NoTokenReturned");a(this,"message","Did not receive an authentication token.")}},Ht=class extends u{constructor(r,e){super();a(this,"name","UnsupportedVersion");a(this,"version");a(this,"supportedRange");this.version=r,this.supportedRange=e,this.message=`The version "${r}" reported by the engine is not supported by this library, expected a version that satisfies "${e}".`}},Me=class extends u{constructor(r){super();a(this,"name","VersionRetrievalFailure");a(this,"message","Failed to retrieve remote version. If the server is behind a proxy, make sure it's configured correctly.");this.error=r}},U=class extends u{constructor(r){super();a(this,"message");this.message=r}},me=class extends U{constructor(){super(...arguments);a(this,"name","CborNumberError")}},g=class extends U{constructor(){super(...arguments);a(this,"name","CborRangeError")}},le=class extends U{constructor(){super(...arguments);a(this,"name","CborInvalidMajorError")}},K=class extends U{constructor(){super("Came across a break which was not intercepted by the decoder");a(this,"name","CborBreak")}},wt=class extends U{constructor(){super("Tried to insert a Gap into a CBOR value, while partial mode is not enabled");a(this,"name","CborPartialDisabled")}},mt=class extends U{constructor(){super("Fill for a gap is missing, and gap has no default");a(this,"name","CborFillMissing")}},B=class{constructor(t=256){a(this,"_chunks",[]);a(this,"_pos",0);a(this,"_buf");a(this,"_view");a(this,"_byte");this.byteLength=t,this._buf=new ArrayBuffer(this.byteLength),this._view=new DataView(this._buf),this._byte=new Uint8Array(this._buf)}chunk(t){this._chunks.push([this._buf.slice(0,this._pos),t]),this._buf=new ArrayBuffer(this.byteLength),this._view=new DataView(this._buf),this._byte=new Uint8Array(this._buf),this._pos=0}get chunks(){return this._chunks}get buffer(){return this._buf.slice(0,this._pos)}claim(t){let r=this._pos;if(this._pos+=t,this._pos<=this._buf.byteLength)return r;let e=this._buf.byteLength<<1;for(;e<this._pos;)e<<=1;if(e>this._buf.byteLength){let n=this._byte;this._buf=new ArrayBuffer(e),this._view=new DataView(this._buf),this._byte=new Uint8Array(this._buf),this._byte.set(n)}return r}writeUint8(t){let r=this.claim(1);this._view.setUint8(r,t)}writeUint16(t){let r=this.claim(2);this._view.setUint16(r,t)}writeUint32(t){let r=this.claim(4);this._view.setUint32(r,t)}writeUint64(t){let r=this.claim(8);this._view.setBigUint64(r,t)}writeUint8Array(t){if(t.byteLength===0)return;let r=this.claim(t.byteLength);this._byte.set(t,r)}writeArrayBuffer(t){t.byteLength!==0&&this.writeUint8Array(new Uint8Array(t))}writePartiallyEncoded(t){for(let[r,e]of t.chunks)this.writeArrayBuffer(r),this.chunk(e);this.writeArrayBuffer(t.end)}writeFloat32(t){let r=this.claim(4);this._view.setFloat32(r,t)}writeFloat64(t){let r=this.claim(8);this._view.setFloat64(r,t)}writeMajor(t,r){let e=t<<5;r<24?this.writeUint8(e+Number(r)):r<256?(this.writeUint8(e+24),this.writeUint8(Number(r))):r<65536?(this.writeUint8(e+25),this.writeUint16(Number(r))):r<4294967296?(this.writeUint8(e+26),this.writeUint32(Number(r))):(this.writeUint8(e+27),this.writeUint64(BigInt(r)))}output(t,r){return t?new Ae(this._chunks,this.buffer,r):this.buffer}},Ae=class{constructor(t,r,e){this.chunks=t,this.end=r,this.replacer=e}build(t,r){let e=new B,n=new Map(t);for(let[i,o]of this.chunks){let s=n.has(o)||o.hasDefault();if(!r&&!s)throw new mt;if(e.writeArrayBuffer(i),s){let c=n.get(o)??o.default;k(c,{writer:e,replacer:this.replacer})}else e.chunk(o)}return e.writeArrayBuffer(this.end),e.output(!!r,this.replacer)}};function Ue(t,r){return Object.fromEntries(Object.entries(t).map(([e,n])=>[e,k(n,{...r,partial:!0})]))}var f=class{constructor(t,r){this.tag=t,this.value=r}},Ie;function k(t,r={}){let e=r.writer??new B,n=new Map(r.fills??[]);function i(o){let s=r.replacer?r.replacer(o):o;if(s===void 0)return e.writeUint8(247);if(s===null)return e.writeUint8(246);if(s===!0)return e.writeUint8(245);if(s===!1)return e.writeUint8(244);switch(typeof s){case"number":{if(Number.isInteger(s))if(s>=0&&s<=9007199254740992)e.writeMajor(0,s);else if(s<0&&s>=-9007199254740992)e.writeMajor(1,-(s+1));else throw new me("Number too big to be encoded");else e.writeUint8(251),e.writeFloat64(s);return}case"bigint":{if(s>=0&&s<pe)e.writeMajor(0,s);else if(s<=0&&s>=-pe)e.writeMajor(1,-(s+1n));else throw new me("BigInt too big to be encoded");return}case"string":{Ie??(Ie=new TextEncoder);let c=Ie.encode(s);e.writeMajor(3,c.byteLength),e.writeUint8Array(c);return}default:{if(Array.isArray(s)){e.writeMajor(4,s.length);for(let l of s)i(l);return}if(s instanceof f){e.writeMajor(6,s.tag),i(s.value);return}if(s instanceof Ee){e.writeArrayBuffer(s.encoded);return}if(s instanceof ce){if(n.has(s))i(n.get(s));else{if(!r.partial)throw new wt;e.chunk(s)}return}if(s instanceof Ae){let l=s.build(r.fills??[],r.partial);r.partial?e.writePartiallyEncoded(l):e.writeArrayBuffer(l);return}if(s instanceof Uint8Array||s instanceof Uint16Array||s instanceof Uint32Array||s instanceof Int8Array||s instanceof Int16Array||s instanceof Int32Array||s instanceof Float32Array||s instanceof Float64Array||s instanceof ArrayBuffer){let l=new Uint8Array(s);e.writeMajor(2,l.byteLength),e.writeUint8Array(l);return}let c=s instanceof Map?Array.from(s.entries()):Object.entries(s);e.writeMajor(5,c.length);for(let l of c.flat())i(l)}}}return i(t),e.output(!!r.partial,r.replacer)}var ge=class{constructor(t){a(this,"_buf");a(this,"_view");a(this,"_byte");a(this,"_pos",0);this._buf=new ArrayBuffer(t.byteLength),this._view=new DataView(this._buf),this._byte=new Uint8Array(this._buf),this._byte.set(new Uint8Array(t))}read(t,r){return this._pos+=t,r}readUint8(){try{return this.read(1,this._view.getUint8(this._pos))}catch(t){throw t instanceof RangeError?new g(t.message):t}}readUint16(){try{return this.read(2,this._view.getUint16(this._pos))}catch(t){throw t instanceof RangeError?new g(t.message):t}}readUint32(){try{return this.read(4,this._view.getUint32(this._pos))}catch(t){throw t instanceof RangeError?new g(t.message):t}}readUint64(){try{return this.read(8,this._view.getBigUint64(this._pos))}catch(t){throw t instanceof RangeError?new g(t.message):t}}readFloat16(){let t=this.readUint16(),r=(t&32768)>>15,e=(t&31744)>>10,n=t&1023;return e===0?(r?-1:1)*2**-14*(n/2**10):e===31?n?Number.NaN:(r?-1:1)*Number.POSITIVE_INFINITY:(r?-1:1)*2**(e-15)*(1+n/2**10)}readFloat32(){try{return this.read(4,this._view.getFloat32(this._pos))}catch(t){throw t instanceof RangeError?new g(t.message):t}}readFloat64(){try{return this.read(8,this._view.getFloat64(this._pos))}catch(t){throw t instanceof RangeError?new g(t.message):t}}readBytes(t){let r=this._byte.length-this._pos;if(r<t)throw new g(`The argument must be between 0 and ${r}`);return this.read(t,this._byte.slice(this._pos,this._pos+t))}readMajor(){let t=this.readUint8(),r=t>>5;if(r<0||r>7)throw new le("Received invalid major type");return[r,t&31]}readMajorLength(t){if(t<=23)return t;switch(t){case 24:return this.readUint8();case 25:return this.readUint16();case 26:return this.readUint32();case 27:{let r=this.readUint64();return r>9007199254740992?r:Number(r)}}throw new g("Expected a final length")}};function be(t,r){let e=new B;for(;;){let[n,i]=t.readMajor();if(n===7&&i===31)break;if(n!==r)throw new le(`Expected a resource of the same major (${r}) while processing an infinite resource`);if(i===31)throw new g("Expected a finite resource while processing an infinite resource");e.writeUint8Array(t.readBytes(Number(t.readMajorLength(i))))}return e.buffer}var je;function gt(t,r={}){let e=t instanceof ge?t:new ge(t);function n(){let[o,s]=e.readMajor();switch(o){case 0:return e.readMajorLength(s);case 1:{let c=e.readMajorLength(s);return typeof c=="bigint"?-(c+1n):-(c+1)}case 2:return s===31?be(e,2):e.readBytes(Number(e.readMajorLength(s))).buffer;case 3:{let c=s===31?be(e,3):e.readBytes(Number(e.readMajorLength(s)));return je??(je=new TextDecoder),je.decode(c)}case 4:{if(s===31){let h=[];for(;;)try{h.push(i())}catch(p){if(p instanceof K)break;throw p}return h}let c=e.readMajorLength(s),l=Array(c);for(let h=0;h<c;h++)l[h]=i();return l}case 5:{let c=[];if(s===31)for(;;){let l;try{l=i()}catch(p){if(p instanceof K)break;throw p}let h=i();c.push([l,h])}else{let l=e.readMajorLength(s);for(let h=0;h<l;h++){let p=i(),y=i();c[h]=[p,y]}}return r.map==="map"?new Map(c):Object.fromEntries(c)}case 6:{let c=e.readMajorLength(s),l=i();return new f(c,l)}case 7:switch(s){case 20:return!1;case 21:return!0;case 22:return null;case 23:return;case 25:return e.readFloat16();case 26:return e.readFloat32();case 27:return e.readFloat64();case 31:throw new K}}throw new le(`Unable to decode value with major tag ${o}`)}function i(){return r.replacer?r.replacer(n()):n()}return i()}function er(t){let r=Math.floor(t.getTime()/1e3),e=t.getTime()-r*1e3;return[r,e*1e6]}function tr([t,r]){let e=new Date(0);return e.setUTCSeconds(Number(t)),e.setMilliseconds(Math.floor(Number(r)/1e6)),e}var m=class{},P=class bt extends m{constructor(e){super();a(this,"decimal");this.decimal=e.toString()}equals(e){return e instanceof bt?this.decimal===e.decimal:!1}toString(){return this.decimal}toJSON(){return this.decimal}},Re=1,O=Re/1e3,ye=O/1e3,re=1e3*Re,ne=60*re,ie=60*ne,se=24*ie,ve=7*se,xe=new Map([["ns",ye],["µs",O],["μs",O],["us",O],["ms",Re],["s",re],["m",ne],["h",ie],["d",se],["w",ve]]),rr=Array.from(xe).reduce((t,[r,e])=>(t.set(e,r),t),new Map),nr=new RegExp(`^(\\d+)(${Array.from(xe.keys()).join("|")})`),G=class w extends m{constructor(e){super();a(this,"_milliseconds");e instanceof w?this._milliseconds=e._milliseconds:typeof e=="string"?this._milliseconds=w.parseString(e):this._milliseconds=e}static fromCompact([e,n]){e=e??0,n=n??0;let i=e*1e3+n/1e6;return new w(i)}equals(e){return e instanceof w?this._milliseconds===e._milliseconds:!1}toCompact(){let e=Math.floor(this._milliseconds/1e3),n=Math.floor((this._milliseconds-e*1e3)*1e6);return n>0?[e,n]:e>0?[e]:[]}toString(){let e=this._milliseconds,n="";function i(o){let s=Math.floor(e/o);return s>0&&(e=e%o),s}for(let[o,s]of Array.from(rr).reverse()){let c=i(o);c>0&&(n+=`${c}${s}`)}return n}toJSON(){return this.toString()}static parseString(e){let n=0,i=e;for(;i!=="";){let o=i.match(nr);if(o){let s=Number.parseInt(o[1]),c=xe.get(o[2]);if(c===void 0)throw new u(`Invalid duration unit: ${o[2]}`);n+=s*c,i=i.slice(o[0].length);continue}throw new u("Could not match a next duration part")}return n}static nanoseconds(e){return new w(Math.floor(e*ye))}static microseconds(e){return new w(Math.floor(e*O))}static milliseconds(e){return new w(e)}static seconds(e){return new w(e*re)}static minutes(e){return new w(e*ne)}static hours(e){return new w(e*ie)}static days(e){return new w(e*se)}static weeks(e){return new w(e*ve)}get microseconds(){return Math.floor(this._milliseconds/O)}get nanoseconds(){return Math.floor(this._milliseconds/ye)}get milliseconds(){return Math.floor(this._milliseconds)}get seconds(){return Math.floor(this._milliseconds/re)}get minutes(){return Math.floor(this._milliseconds/ne)}get hours(){return Math.floor(this._milliseconds/ie)}get days(){return Math.floor(this._milliseconds/se)}get weeks(){return Math.floor(this._milliseconds/ve)}},oe=class yt extends m{constructor(r){super(),this.inner=r}equals(r){return r instanceof yt?this.inner===r.inner:!1}toJSON(){return this.toString()}toString(){return`<future> ${this.inner}`}},v=class vt extends m{equals(r){return r instanceof vt?this.is(r):!1}toString(){return JSON.stringify(this.toJSON())}};function Le(t){return t instanceof P?Number.parseFloat(t.decimal):t}var $e=class X extends v{constructor(e){super();a(this,"point");e instanceof X?this.point=e.clone().point:this.point=[Le(e[0]),Le(e[1])]}toJSON(){return{type:"Point",coordinates:this.coordinates}}get coordinates(){return this.point}is(e){return e instanceof X?this.point[0]===e.point[0]&&this.point[1]===e.point[1]:!1}clone(){return new X([...this.point])}},Ge=class z extends v{constructor(e){super();a(this,"line");this.line=e instanceof z?e.clone().line:e}toJSON(){return{type:"LineString",coordinates:this.coordinates}}get coordinates(){return this.line.map(e=>e.coordinates)}close(){this.line[0].is(this.line.at(-1))||this.line.push(this.line[0])}is(e){if(!(e instanceof z)||this.line.length!==e.line.length)return!1;for(let n=0;n<this.line.length;n++)if(!this.line[n].is(e.line[n]))return!1;return!0}clone(){return new z(this.line.map(e=>e.clone()))}},Pe=class Q extends v{constructor(e){super();a(this,"polygon");this.polygon=e instanceof Q?e.clone().polygon:e.map(n=>{let i=n.clone();return i.close(),i})}toJSON(){return{type:"Polygon",coordinates:this.coordinates}}get coordinates(){return this.polygon.map(e=>e.coordinates)}is(e){if(!(e instanceof Q)||this.polygon.length!==e.polygon.length)return!1;for(let n=0;n<this.polygon.length;n++)if(!this.polygon[n].is(e.polygon[n]))return!1;return!0}clone(){return new Q(this.polygon.map(e=>e.clone()))}},Be=class Z extends v{constructor(e){super();a(this,"points");this.points=e instanceof Z?e.points:e}toJSON(){return{type:"MultiPoint",coordinates:this.coordinates}}get coordinates(){return this.points.map(e=>e.coordinates)}is(e){if(!(e instanceof Z)||this.points.length!==e.points.length)return!1;for(let n=0;n<this.points.length;n++)if(!this.points[n].is(e.points[n]))return!1;return!0}clone(){return new Z(this.points.map(e=>e.clone()))}},Ve=class H extends v{constructor(e){super();a(this,"lines");this.lines=e instanceof H?e.lines:e}toJSON(){return{type:"MultiLineString",coordinates:this.coordinates}}get coordinates(){return this.lines.map(e=>e.coordinates)}is(e){if(!(e instanceof H)||this.lines.length!==e.lines.length)return!1;for(let n=0;n<this.lines.length;n++)if(!this.lines[n].is(e.lines[n]))return!1;return!0}clone(){return new H(this.lines.map(e=>e.clone()))}},Fe=class ee extends v{constructor(e){super();a(this,"polygons");this.polygons=e instanceof ee?e.polygons:e}toJSON(){return{type:"MultiPolygon",coordinates:this.coordinates}}get coordinates(){return this.polygons.map(e=>e.coordinates)}is(e){if(!(e instanceof ee)||this.polygons.length!==e.polygons.length)return!1;for(let n=0;n<this.polygons.length;n++)if(!this.polygons[n].is(e.polygons[n]))return!1;return!0}clone(){return new ee(this.polygons.map(e=>e.clone()))}},Je=class te extends v{constructor(e){super();a(this,"collection");this.collection=e instanceof te?e.collection:e}toJSON(){return{type:"GeometryCollection",geometries:this.geometries}}get geometries(){return this.collection.map(e=>e.toJSON())}is(e){if(!(e instanceof te)||this.collection.length!==e.collection.length)return!1;for(let n=0;n<this.collection.length;n++)if(!this.collection[n].is(e.collection[n]))return!1;return!0}clone(){return new te(this.collection.map(e=>e.clone()))}};function T(t,r){if(Object.is(t,r))return!0;if(t instanceof Date&&r instanceof Date)return t.getTime()===r.getTime();if(t instanceof RegExp&&r instanceof RegExp)return t.toString()===r.toString();if(t instanceof m&&r instanceof m)return t.equals(r);if(typeof t!="object"||t===null||typeof r!="object"||r===null)return!1;let e=Reflect.ownKeys(t),n=Reflect.ownKeys(r);if(e.length!==n.length)return!1;for(let i=0;i<e.length;i++)if(!Reflect.has(r,e[i])||!T(t[e[i]],r[e[i]]))return!1;return!0}var ir=9223372036854775807n;function he(t){if(or(t))return`⟨${t}⟩`;if(t==="")return"⟨⟩";let r,e,n;for(e=0,n=t.length;e<n;e++)if(r=t.charCodeAt(e),!(r>47&&r<58)&&!(r>64&&r<91)&&!(r>96&&r<123)&&r!==95)return`⟨${t.replaceAll("⟩","\\⟩")}⟩`;return t}function jr(t){return he(t)}function sr(t){return t<=ir?t.toString():`⟨${t}⟩`}function or(t){return/^\d+$/.test(t.replace(/_/g,""))}var F="0123456789abcdef",x=class L{constructor(r){this.bytes=r}static ofInner(r){if(r.length!==16)throw new TypeError("not 128-bit length");return new L(r)}static fromFieldsV7(r,e,n,i){if(!Number.isInteger(r)||!Number.isInteger(e)||!Number.isInteger(n)||!Number.isInteger(i)||r<0||e<0||n<0||i<0||r>0xffffffffffff||e>4095||n>1073741823||i>4294967295)throw new RangeError("invalid field value");let o=new Uint8Array(16);return o[0]=r/2**40,o[1]=r/2**32,o[2]=r/2**24,o[3]=r/2**16,o[4]=r/2**8,o[5]=r,o[6]=112|e>>>8,o[7]=e,o[8]=128|n>>>24,o[9]=n>>>16,o[10]=n>>>8,o[11]=n,o[12]=i>>>24,o[13]=i>>>16,o[14]=i>>>8,o[15]=i,new L(o)}static parse(r){var e,n,i,o;let s;switch(r.length){case 32:s=(e=/^[0-9a-f]{32}$/i.exec(r))===null||e===void 0?void 0:e[0];break;case 36:s=(n=/^([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})$/i.exec(r))===null||n===void 0?void 0:n.slice(1,6).join("");break;case 38:s=(i=/^\{([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})\}$/i.exec(r))===null||i===void 0?void 0:i.slice(1,6).join("");break;case 45:s=(o=/^urn:uuid:([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})$/i.exec(r))===null||o===void 0?void 0:o.slice(1,6).join("");break}if(s){let c=new Uint8Array(16);for(let l=0;l<16;l+=4){let h=parseInt(s.substring(2*l,2*l+8),16);c[l+0]=h>>>24,c[l+1]=h>>>16,c[l+2]=h>>>8,c[l+3]=h}return new L(c)}else throw new SyntaxError("could not parse UUID string")}toString(){let r="";for(let e=0;e<this.bytes.length;e++)r+=F.charAt(this.bytes[e]>>>4),r+=F.charAt(this.bytes[e]&15),(e===3||e===5||e===7||e===9)&&(r+="-");return r}toHex(){let r="";for(let e=0;e<this.bytes.length;e++)r+=F.charAt(this.bytes[e]>>>4),r+=F.charAt(this.bytes[e]&15);return r}toJSON(){return this.toString()}getVariant(){let r=this.bytes[8]>>>4;if(r<0)throw new Error("unreachable");if(r<=7)return this.bytes.every(e=>e===0)?"NIL":"VAR_0";if(r<=11)return"VAR_10";if(r<=13)return"VAR_110";if(r<=15)return this.bytes.every(e=>e===255)?"MAX":"VAR_RESERVED";throw new Error("unreachable")}getVersion(){return this.getVariant()==="VAR_10"?this.bytes[6]>>>4:void 0}clone(){return new L(this.bytes.slice(0))}equals(r){return this.compareTo(r)===0}compareTo(r){for(let e=0;e<16;e++){let n=this.bytes[e]-r.bytes[e];if(n!==0)return Math.sign(n)}return 0}},_t=class{constructor(t){this.timestamp=0,this.counter=0,this.random=t??ar()}generate(){return this.generateOrResetCore(Date.now(),1e4)}generateOrAbort(){return this.generateOrAbortCore(Date.now(),1e4)}generateOrResetCore(t,r){let e=this.generateOrAbortCore(t,r);return e===void 0&&(this.timestamp=0,e=this.generateOrAbortCore(t,r)),e}generateOrAbortCore(t,r){if(!Number.isInteger(t)||t<1||t>0xffffffffffff)throw new RangeError("`unixTsMs` must be a 48-bit positive integer");if(r<0||r>0xffffffffffff)throw new RangeError("`rollbackAllowance` out of reasonable range");if(t>this.timestamp)this.timestamp=t,this.resetCounter();else if(t+r>=this.timestamp)this.counter++,this.counter>4398046511103&&(this.timestamp++,this.resetCounter());else return;return x.fromFieldsV7(this.timestamp,Math.trunc(this.counter/2**30),this.counter&2**30-1,this.random.nextUint32())}resetCounter(){this.counter=this.random.nextUint32()*1024+(this.random.nextUint32()&1023)}generateV4(){let t=new Uint8Array(Uint32Array.of(this.random.nextUint32(),this.random.nextUint32(),this.random.nextUint32(),this.random.nextUint32()).buffer);return t[6]=64|t[6]>>>4,t[8]=128|t[8]>>>2,x.ofInner(t)}},ar=()=>{if(typeof crypto<"u"&&typeof crypto.getRandomValues<"u")return new cr;if(typeof UUIDV7_DENY_WEAK_RNG<"u"&&UUIDV7_DENY_WEAK_RNG)throw new Error("no cryptographically strong RNG available");return{nextUint32:()=>Math.trunc(Math.random()*65536)*65536+Math.trunc(Math.random()*65536)}},cr=class{constructor(){this.buffer=new Uint32Array(8),this.cursor=65535}nextUint32(){return this.cursor>=this.buffer.length&&(crypto.getRandomValues(this.buffer),this.cursor=0),this.buffer[this.cursor++]}},ae,lr=()=>(ae||(ae=new _t)).generate(),hr=()=>(ae||(ae=new _t)).generateV4(),E=class $ extends m{constructor(e){super();a(this,"inner");e instanceof ArrayBuffer?this.inner=x.ofInner(new Uint8Array(e)):e instanceof Uint8Array?this.inner=x.ofInner(e):e instanceof $?this.inner=e.inner:e instanceof x?this.inner=e:this.inner=x.parse(e)}equals(e){return e instanceof $?this.inner.equals(e.inner):!1}toString(){return this.inner.toString()}toJSON(){return this.inner.toString()}toUint8Array(){return this.inner.bytes}toBuffer(){return this.inner.bytes.buffer}static v4(){return new $(hr())}static v7(){return new $(lr())}},D=class St extends m{constructor(e,n){super();a(this,"tb");a(this,"id");if(typeof e!="string")throw new u("TB part is not valid");if(!Et(n))throw new u("ID part is not valid");this.tb=e,this.id=n}equals(e){return e instanceof St?this.tb===e.tb&&T(this.id,e.id):!1}toJSON(){return this.toString()}toString(){let e=he(this.tb),n=At(this.id);return`${e}:${n}`}},V=class _e extends m{constructor(e){super();a(this,"rid");if(e instanceof _e)this.rid=e.rid;else if(e instanceof D)this.rid=e.toString();else if(typeof e=="string")this.rid=e;else throw new u("String Record ID must be a string")}equals(e){return e instanceof _e?this.rid===e.rid:!1}toJSON(){return this.rid}toString(){return this.rid}};function Et(t){if(t instanceof E)return!0;switch(typeof t){case"string":case"number":case"bigint":return!0;case"object":return Array.isArray(t)||t!==null;default:return!1}}function At(t){return t instanceof E?`u"${t}"`:typeof t=="string"?he(t):typeof t=="bigint"||typeof t=="number"?sr(t):S(t)}var A=class Ut extends m{constructor(e){super();a(this,"tb");if(typeof e!="string")throw new u("Table must be a string");this.tb=e}equals(e){return e instanceof Ut?this.tb===e.tb:!1}toJSON(){return this.tb}toString(){return this.tb}};function S(t){if(typeof t=="string")return`s${JSON.stringify(t)}`;if(t===null)return"NULL";if(t===void 0)return"NONE";if(typeof t=="object"){if(t instanceof Date)return`d${JSON.stringify(t.toISOString())}`;if(t instanceof E)return`u${JSON.stringify(t.toString())}`;if(t instanceof D||t instanceof V)return`r${JSON.stringify(t.toString())}`;if(t instanceof v)return S(t.toJSON());if(t instanceof P||t instanceof G||t instanceof oe||t instanceof C||t instanceof A)return t.toJSON();switch(Object.getPrototypeOf(t)){case Object.prototype:{let r="{ ",e=Object.entries(t);for(let[n,[i,o]]of e.entries())r+=`${JSON.stringify(i)}: ${S(o)}`,n<e.length-1&&(r+=", ");return r+=" }",r}case Map.prototype:{let r="{ ",e=Array.from(t.entries());for(let[n,[i,o]]of e.entries())r+=`${JSON.stringify(i)}: ${S(o)}`,n<e.length-1&&(r+=", ");return r+=" }",r}case Array.prototype:return`[ ${t.map(S).join(", ")} ]`;case Set.prototype:return`[ ${[...new Set([...t].map(S))].join(", ")} ]`}}return`${t}`}var C=class Rt extends m{constructor(r,e){super(),this.beg=r,this.end=e}equals(r){var e,n,i,o,s,c,l,h;return!(r instanceof Rt)||((e=this.beg)==null?void 0:e.constructor)!==((n=r.beg)==null?void 0:n.constructor)||((i=this.end)==null?void 0:i.constructor)!==((o=r.end)==null?void 0:o.constructor)?!1:T((s=this.beg)==null?void 0:s.value,(c=r.beg)==null?void 0:c.value)&&T((l=this.end)==null?void 0:l.value,(h=r.end)==null?void 0:h.value)}toJSON(){return this.toString()}toString(){let r=Ye(this.beg),e=Ye(this.end);return`${r}${Nt(this.beg,this.end)}${e}`}},I=class{constructor(t){this.value=t}},j=class{constructor(t){this.value=t}},Se=class xt extends m{constructor(r,e,n){if(super(),this.tb=r,this.beg=e,this.end=n,typeof r!="string")throw new u("TB part is not valid");if(!We(e))throw new u("Beg part is not valid");if(!We(n))throw new u("End part is not valid")}equals(r){var e,n,i,o,s,c,l,h;return!(r instanceof xt)||((e=this.beg)==null?void 0:e.constructor)!==((n=r.beg)==null?void 0:n.constructor)||((i=this.end)==null?void 0:i.constructor)!==((o=r.end)==null?void 0:o.constructor)?!1:this.tb===r.tb&&T((s=this.beg)==null?void 0:s.value,(c=r.beg)==null?void 0:c.value)&&T((l=this.end)==null?void 0:l.value,(h=r.end)==null?void 0:h.value)}toJSON(){return this.toString()}toString(){let r=he(this.tb),e=qe(this.beg),n=qe(this.end);return`${r}:${e}${Nt(this.beg,this.end)}${n}`}};function Nt(t,r){let e="";return t instanceof j&&(e+=">"),e+="..",r instanceof I&&(e+="="),e}function We(t){return t instanceof I||t instanceof j?Et(t.value):!0}function qe(t){return t instanceof I||t instanceof j?At(t.value):""}function Ye(t){if(t===void 0)return"";let r=t.value;return t instanceof C?`(${S(r)})`:S(r)}function Ke([t,r]){function e(n){return n instanceof I?new f(Ot,n.value):n instanceof j?new f(Ct,n.value):null}return[e(t),e(r)]}function ur(t){function r(e){if(e!==null){if(e instanceof I||e instanceof j)return e;throw new u("Expected the bounds to be decoded already")}}return[r(t[0]),r(t[1])]}var dr=0,Xe=37,ze=6,Qe=7,J=8,fr=9,Ze=10,He=12,pr=13,et=14,tt=15,ue=49,Ot=50,Ct=51,rt=88,nt=89,it=90,st=91,ot=92,at=93,ct=94,M={encode(t){return t instanceof Date?new f(He,er(t)):t===void 0?new f(ze,null):t instanceof E?new f(Xe,t.toBuffer()):t instanceof P?new f(Ze,t.toString()):t instanceof G?new f(et,t.toCompact()):t instanceof D?new f(J,[t.tb,t.id]):t instanceof V?new f(J,t.rid):t instanceof Se?new f(J,[t.tb,new f(ue,Ke([t.beg,t.end]))]):t instanceof A?new f(Qe,t.tb):t instanceof oe?new f(tt,t.inner):t instanceof C?new f(ue,Ke([t.beg,t.end])):t instanceof $e?new f(rt,t.point):t instanceof Ge?new f(nt,t.line):t instanceof Pe?new f(it,t.polygon):t instanceof Be?new f(st,t.points):t instanceof Ve?new f(ot,t.lines):t instanceof Fe?new f(at,t.polygons):t instanceof Je?new f(ct,t.collection):t},decode(t){if(!(t instanceof f))return t;switch(t.tag){case dr:return new Date(t.value);case Xe:case fr:return new E(t.value);case He:return tr(t.value);case ze:return;case Ze:return new P(t.value);case pr:return new G(t.value);case et:return G.fromCompact(t.value);case Qe:return new A(t.value);case tt:return new oe(t.value);case ue:return new C(...ur(t.value));case Ot:return new I(t.value);case Ct:return new j(t.value);case J:return t.value[1]instanceof C?new Se(t.value[0],t.value[1].beg,t.value[1].end):new D(t.value[0],t.value[1]);case rt:return new $e(t.value);case nt:return new Ge(t.value);case it:return new Pe(t.value);case st:return new Be(t.value);case ot:return new Ve(t.value);case at:return new Fe(t.value);case ct:return new Je(t.value)}}};Object.freeze(M);function wr(t){return k(t,{replacer:M.encode})}function mr(t){return gt(t,{replacer:M.decode})}var W,kt=class{constructor(t,r){a(this,"_query");a(this,"_bindings");a(this,"length");W??(W=new TextEncoder),this._query=W.encode(t),this._bindings=Ue(r??{},{replacer:M.encode}),this.length=Object.keys(this._bindings).length}get query(){let t=new B(this._query.byteLength+9);return t.writeMajor(3,this._query.byteLength),t.writeUint8Array(this._query),new Ee(t.output(!1))}get bindings(){return this._bindings}build(t){return k([this.query,this.bindings],{fills:t})}append(t,...r){let e=this.length;this.length+=r.length;let n=0,i=new Map,o=r.map((h,p)=>{if(h instanceof ce){let y=i.get(h);if(y!==void 0)return n++,[`bind___${y}`,h];i.set(h,p-n)}return[`bind___${e+p-n}`,h]});for(let[h,p]of o)this._bindings[h]=k(p,{replacer:M.encode,partial:!0});let s=t.flatMap((h,p)=>{var R;let y=(R=o[p])==null?void 0:R[0];return[h,...y?[`$${y}`]:[]]}).join("");W??(W=new TextEncoder);let c=new Uint8Array(this._query),l=W.encode(s);return this._query=new Uint8Array(c.byteLength+l.byteLength),this._query.set(c),this._query.set(l,c.byteLength),this}};function Lr(t,...r){let e=0,n=new Map,i=r.map((c,l)=>{if(c instanceof ce){let h=n.get(c);if(h!==void 0)return e++,[`bind___${h}`,c];n.set(c,l-e)}return[`bind___${l-e}`,c]}),o=i.reduce((c,[l,h])=>(c[l]=h,c),{}),s=t.flatMap((c,l)=>{var p;let h=(p=i[l])==null?void 0:p[0];return[c,...h?[`$${h}`]:[]]}).join("");return new kt(s,o)}function lt(t){let r={},e=(n,i,o)=>{if(n in t)r[i]=`${t[n]}`,delete r[n];else if(o!==!0)throw new u(`Key ${n} is missing from the authentication parameters`)};return"scope"in t?(r={...t},e("scope","sc"),e("namespace","ns"),e("database","db")):"variables"in t?(r={...t.variables},e("access","ac"),e("namespace","ns"),e("database","db")):(e("access","ac",!0),e("database","db",!0),e("namespace","ns",!("database"in t)),e("username","user"),e("password","pass")),r}var gr=["CREATE","UPDATE","DELETE"];function br(t){return!(typeof t!="object"||t===null||!("id"in t&&"action"in t&&"result"in t)||!(t.id instanceof E)||!gr.includes(t.action)||typeof t.result!="object"||t.result===null)}var de={enabled:!0,attempts:5,retryDelay:1e3,retryDelayMax:6e4,retryDelayMultiplier:2,retryDelayJitter:.1};function q(t){if(typeof t=="object"){if(t===null)return null;if(t instanceof Date||t instanceof E||t instanceof P||t instanceof G||t instanceof oe||t instanceof C||t instanceof V||t instanceof Se||t instanceof D||t instanceof v||t instanceof A)return t.toJSON();switch(Object.getPrototypeOf(t)){case Object.prototype:{let r=Object.entries(t).map(([e,n])=>[e,q(n)]).filter(([e,n])=>n!==void 0);return Object.fromEntries(r)}case Map.prototype:{let r=Array.from(t).map(([e,n])=>[e,q(n)]).filter(([e,n])=>n!==void 0);return new Map(r)}case Array.prototype:return t.map(q);case Set.prototype:return new Set([...t].map(q))}}return t}var yr=5e3,Ne="1.4.2",Oe="3.0.0",$r=`>= ${Ne} < ${Oe}`;function vr(t,r=Ne,e=Oe){if(!_r(t,r,e))throw new Ht(t,`>= ${r} < ${e}`);return!0}function _r(t,r=Ne,e=Oe){return r.localeCompare(t,void 0,{numeric:!0})<=0&&e.localeCompare(t,void 0,{numeric:!0})===1}async function Tt(t,r){let e={"ws:":"http:","wss:":"https:","http:":"http:","https:":"https:"}[t.protocol];if(e){let n=t.pathname.slice(0,-4);t=new URL(t),t.pathname=`${n}/version`,t.protocol=e;let i=new AbortController,o=setTimeout(()=>i.abort(),r??yr),s="surrealdb-";return await fetch(t,{signal:i.signal}).then(c=>c.text()).then(c=>c.slice(s.length)).catch(c=>{throw new Me(c)}).finally(()=>{clearTimeout(o)})}throw new Me}var fe=0;function Dt(){return fe=(fe+1)%Number.MAX_SAFE_INTEGER,fe.toString()}function Ce(t,...r){return t.reduce((e,n,i)=>`${e}${n}${r[i]??""}`,"")}function Gr(t,...r){return new Date(Ce(t,r))}function Pr(t,...r){return new V(Ce(t,r))}function Br(t,...r){return new E(Ce(t,r))}var ht=Symbol("RetryMessage"),Sr=(t=>(t.Disconnected="disconnected",t.Connecting="connecting",t.Reconnecting="reconnecting",t.Connected="connected",t.Error="error",t))(Sr||{}),Er=class{constructor({emitter:t,encodeCbor:r,decodeCbor:e,reconnect:n,prepare:i}){a(this,"emitter");a(this,"encodeCbor");a(this,"decodeCbor");a(this,"reconnect");a(this,"prepare");this.emitter=t,this.encodeCbor=r,this.decodeCbor=e,this.reconnect=n,this.prepare=i}},Ar=class{constructor(t){a(this,"context");a(this,"ready");a(this,"status","disconnected");a(this,"connection",{url:void 0,namespace:void 0,database:void 0,token:void 0});this.context=t}get emitter(){return this.context.emitter}get encodeCbor(){return this.context.encodeCbor}get decodeCbor(){return this.context.decodeCbor}};function ut(t,r){if("scope"in t||"access"in t&&"variables"in t&&t.variables){if(!t.namespace){if(!(r!=null&&r.namespace))throw new Qt;t.namespace=r.namespace}if(!t.database){if(!(r!=null&&r.database))throw new Zt;t.database=r.database}}return t}var Mt=class{async signup(t){if(!this.connection)throw new b;let r=ut(t,this.connection.connection),e=lt(r),n=await this.rpc("signup",[e]);if(n.error)throw new d(n.error.message);if(!n.result)throw new De;return n.result}async signin(t){if(!this.connection)throw new b;let r=ut(t,this.connection.connection),e=lt(r),n=await this.rpc("signin",[e]);if(n.error)throw new d(n.error.message);if(!n.result)throw new De;return n.result}async authenticate(t){let r=await this.rpc("authenticate",[t]);if(r.error)throw new d(r.error.message);return!0}async invalidate(){let t=await this.rpc("invalidate");if(t.error)throw new d(t.error.message);return!0}},It=class extends Mt{constructor(t){super(),this.connection=t}rpc(t,r){if(!this.connection)throw new b;return this.connection.rpc({method:t,params:r},!0)}},jt=class extends Ar{async req_post(t,r,e){let n={"Content-Type":"application/cbor",Accept:"application/cbor",...e};this.connection.namespace&&(n["Surreal-NS"]=this.connection.namespace),this.connection.database&&(n["Surreal-DB"]=this.connection.database),this.connection.token&&(n.Authorization=`Bearer ${this.connection.token}`);let i=await fetch(`${r??this.connection.url}`,{method:"POST",headers:n,body:this.encodeCbor(t)}),o=await i.arrayBuffer();if(i.status===200)return o;let s=new TextDecoder("utf-8");throw new zt(s.decode(o),i.status,i.statusText,o)}},Ur=new Set(["signin","signup","authenticate","invalidate","version","use","let","unset","query"]),dt=class extends jt{constructor(){super(...arguments);a(this,"connection",{url:void 0,namespace:void 0,database:void 0,token:void 0,variables:{}})}setStatus(r,...e){this.status=r,this.emitter.emit(r,e)}version(r,e){return Tt(r,e)}async connect(r){var e,n;return this.setStatus("connecting"),this.connection.url=r,await((n=(e=this.context).prepare)==null?void 0:n.call(e,new It(this))),this.setStatus("connected"),this.ready=new Promise(i=>i()),this.ready}disconnect(){return this.connection={url:void 0,namespace:void 0,database:void 0,token:void 0,variables:{}},this.ready=void 0,this.setStatus("disconnected"),new Promise(r=>r())}async rpc(r,e){var s,c;if(e||await this.ready,!this.connection.url)throw new N;if((!this.connection.namespace||!this.connection.database)&&!Ur.has(r.method))throw new Xt;if(r.method==="use"){let[l,h]=r.params;return l===null&&(this.connection.namespace=void 0),h===null&&(this.connection.database=void 0),l&&(this.connection.namespace=l),h&&(this.connection.database=h),{result:!0}}if(r.method==="let"){let[l,h]=r.params;return this.connection.variables[l]=h,{result:!0}}if(r.method==="unset"){let[l]=r.params;return delete this.connection.variables[l],{result:!0}}r.method==="query"&&(r.params=[(s=r.params)==null?void 0:s[0],{...this.connection.variables,...((c=r.params)==null?void 0:c[1])??{}}]);let n=Dt(),i=await this.req_post({id:n,...r}),o=this.decodeCbor(i);if("result"in o)switch(r.method){case"signin":case"signup":{this.connection.token=o.result;break}case"authenticate":{let[l]=r.params;this.connection.token=l;break}case"invalidate":{this.connection.token=void 0;break}}return this.emitter.emit(`rpc-${n}`,[o]),o}get connected(){return!!this.connection.url}async export(r){if(!this.connection.url)throw new N;let e=new URL(this.connection.url),n=e.pathname.slice(0,-4);e.pathname=`${n}/export`;let i=await this.req_post(r??{},e,{Accept:"plain/text"});return new TextDecoder("utf-8").decode(i)}async import(r){if(!this.connection.url)throw new N;let e=new URL(this.connection.url),n=e.pathname.slice(0,-4);e.pathname=`${n}/import`,await this.req_post(r,e,{Accept:"application/json"})}};function Rr(){if(typeof WebSocket<"u")return WebSocket;if(typeof global.WebSocket<"u")return global.WebSocket;if(typeof window.WebSocket<"u")return window.WebSocket;if(typeof self.WebSocket<"u")return self.WebSocket;throw new Error("`WebSocket` is not supported in this environment")}var ft=Rr();function Y(){let t={completed:!1};return t.promise=new Promise((r,e)=>{t.resolve=n=>{t.completed=!0,r(n)},t.reject=n=>{t.completed=!0,e(n)}}),t}var pt=class extends jt{constructor(r){super(r);a(this,"pinger");a(this,"socket");a(this,"disconnected");this.disconnected=Y()}setStatus(r,...e){this.connection.url&&r==="disconnected"||r==="error"?(this.disconnected.resolve(),this.disconnected=Y()):(this.status=r,this.emitter.emit(r,e))}async requireStatus(r){return this.status!==r&&await this.emitter.subscribeOnce(r),!0}version(r,e){return Tt(r,e)}async connect(r){this.connection.url=r,(async()=>{let e=!0,n;for(;this.connection.url;)if(e)e=!1,this.setStatus("connecting"),this.ready=this.createSocket(),await this.disconnected.promise;else{if(!this.context.reconnect.enabled)break;if(!n){let{promise:s,resolve:c,reject:l}=Y();this.ready=s,n=[c,l]}let[i,o]=n;if(!this.context.reconnect.allowed){this.connection={url:void 0,namespace:void 0,database:void 0,token:void 0},this.socket=void 0,o(new ke),this.emitter.emit("error",[new ke]),this.setStatus("disconnected");break}this.setStatus("reconnecting"),await this.context.reconnect.iterate();try{await this.createSocket()}catch{continue}try{if(this.connection.namespace||this.connection.database){let s=await this.rpc({method:"use",params:[this.connection.namespace,this.connection.database]},!0);if(s.error)throw new d(s.error.message)}if(this.connection.token){let s=await this.rpc({method:"authenticate",params:[this.connection.token]},!0);if(s.error)throw new d(s.error.message)}}catch(s){this.connection={url:void 0,namespace:void 0,database:void 0,token:void 0},this.socket=void 0,o(s),this.emitter.emit("error",[s]),this.setStatus("disconnected");break}this.context.reconnect.reset(),i(),this.emitter.scanListeners(s=>s.startsWith("rpc-")).map(s=>this.emitter.emit(s,[ht])),this.status==="connected"&&await this.disconnected.promise}})(),await this.ready}async createSocket(){let{promise:r,resolve:e,reject:n}=Y();if(!this.connection.url)throw new Wt;let i=new ft(this.connection.url.toString(),"cbor");i.addEventListener("open",async()=>{var o,s,c;this.socket=i,await((s=(o=this.context).prepare)==null?void 0:s.call(o,new It(this))),this.setStatus("connected"),(c=this.pinger)==null||c.stop(),this.pinger=new xr(3e4),this.pinger.start(()=>{try{this.rpc({method:"ping"})}catch{}}),e()}),i.addEventListener("error",o=>{let s=new Yt("detail"in o&&o.detail?o.detail:"message"in o&&o.message?o.message:"error"in o&&o.error?o.error:"An unexpected error occurred");this.setStatus("error",s),n(s)}),i.addEventListener("close",()=>{var o;this.setStatus("disconnected"),(o=this.pinger)==null||o.stop()}),i.addEventListener("message",async({data:o})=>{try{let s=this.decodeCbor(o instanceof ArrayBuffer?o:o instanceof Blob?await o.arrayBuffer():o.buffer.slice(o.byteOffset,o.byteOffset+o.byteLength));if(typeof s=="object"&&s!=null&&Object.getPrototypeOf(s)===Object.prototype)this.handleRpcResponse(s);else throw new Te(s)}catch(s){i.dispatchEvent(new CustomEvent("error",{detail:s}))}}),await r}async disconnect(){var r,e;this.connection={url:void 0,namespace:void 0,database:void 0,token:void 0},await((r=this.ready)==null?void 0:r.catch(()=>{})),(e=this.socket)==null||e.close(),this.ready=void 0,this.socket=void 0,this.disconnected.resolve(),await Promise.any([this.requireStatus("disconnected"),this.requireStatus("error")])}async rpc(r,e){if(e||await this.ready,!this.socket)throw new N;let n;for(;!n;){let i=Dt(),o=this.emitter.subscribeOnce(`rpc-${i}`);if(this.socket.send(this.encodeCbor({id:i,...r})),e&&this.socket.readyState===ft.CLOSED)throw new we;let[s]=await o;if(s instanceof we)throw s;s!==ht&&(n=s)}if("result"in n)switch(r.method){case"use":{let[i,o]=r.params;i===null&&(this.connection.namespace=void 0),o===null&&(this.connection.database=void 0),i&&(this.connection.namespace=i),o&&(this.connection.database=o);break}case"signin":case"signup":{this.connection.token=n.result;break}case"authenticate":{let[i]=r.params;this.connection.token=i;break}case"invalidate":{this.connection.token=void 0;break}}return n}handleRpcResponse({id:r,...e}){if(r)this.emitter.emit(`rpc-${r}`,[e]);else if(e.error)this.setStatus("error",new d(e.error));else if(br(e.result)){let{id:n,action:i,result:o}=e.result;this.emitter.emit(`live-${n}`,[i,o],!0)}else this.setStatus("error",new Te({id:r,...e}))}get connected(){return!!this.socket}async export(r){if(!this.connection.url)throw new N;let e=new URL(this.connection.url),n=e.pathname.slice(0,-4);e.protocol=e.protocol.replace("ws","http"),e.pathname=`${n}/export`;let i=await this.req_post(r??{},e,{Accept:"plain/text"});return new TextDecoder("utf-8").decode(i)}async import(r){if(!this.connection.url)throw new N;let e=new URL(this.connection.url),n=e.pathname.slice(0,-4);e.protocol=e.protocol.replace("ws","http"),e.pathname=`${n}/import`,await this.req_post(r,e,{Accept:"application/json"})}},xr=class{constructor(t=3e4){a(this,"pinger");a(this,"interval");this.interval=t}start(t){this.pinger=setInterval(t,this.interval)}stop(){clearInterval(this.pinger)}};function Nr(t,r){return Math.random()*(r-t)+t}var Or=class{constructor(t,r){a(this,"_attempts",0);a(this,"options");a(this,"surreal");this.surreal=r,t?t===!0?this.options=de:this.options={...de,...t}:this.options={...de,enabled:!1}}get attempts(){return this._attempts}get enabled(){return this.options.enabled}get allowed(){return!(!this.options.enabled||this.options.attempts!==-1&&this._attempts>=this.options.attempts)}reset(){this._attempts=0}async iterate(){if(!this.allowed)throw new qt;this._attempts++;let t=this.options.retryDelayMultiplier**this.attempts,r=this.options.retryDelay*t,e=Nr(-this.options.retryDelayJitter,this.options.retryDelayJitter),n=Math.min(r*(1+e),this.options.retryDelayMax);await new Promise(i=>setTimeout(i,n))}},Vr=class extends Mt{constructor({engines:r}={}){super();a(this,"connection");a(this,"emitter");a(this,"engines",{ws:pt,wss:pt,http:dt,https:dt});a(this,"_ready");this.emitter=new Vt,r&&(this.engines={...this.engines,...r})}async connect(r,e={}){return this._ready=this.connectInner(r,e),await this._ready,!0}async connectInner(r,e={}){let n=Cr(r),i=n.protocol.slice(0,-1),o=this.engines[i];if(!o)throw new Kt(i);let{prepare:s,auth:c,namespace:l,database:h,reconnect:p}=e;await this.close();let y=new Er({emitter:this.emitter,encodeCbor:wr,decodeCbor:mr,reconnect:new Or(p,this),prepare:s}),R=new o(y);if(e.versionCheck!==!1){let Lt=await R.version(n,e.versionCheckTimeout);vr(Lt)}this.connection=R,await R.connect(n),(l||h)&&await this.use({namespace:l,database:h}),typeof c=="string"?await this.authenticate(c):c&&await this.signin(c)}async close(){var r;return this.clean(),await((r=this.connection)==null?void 0:r.disconnect()),!0}clean(){let r=this.emitter.scanListeners(n=>n.startsWith("rpc-"));r.map(n=>this.emitter.emit(n,[new we]));let e=this.emitter.scanListeners(n=>n.startsWith("live-"));e.map(n=>this.emitter.emit(n,["CLOSE","disconnected"])),this.emitter.reset({collectable:!0,listeners:[...r,...e]})}get status(){var r;return((r=this.connection)==null?void 0:r.status)??"disconnected"}get ready(){var r;return Promise.all([this._ready,(r=this.connection)==null?void 0:r.ready]).then(()=>{})}async ping(){let{error:r}=await this.rpc("ping");if(r)throw new d(r.message);return!0}async use({namespace:r,database:e}){if(!this.connection)throw new b;if(r===null&&e!==null)throw new u("Cannot unset namespace without unsetting database");let{error:n}=await this.rpc("use",[r,e]);if(n)throw new d(n.message);return!0}async info(){await this.ready;let r=await this.rpc("info");if(r.error)throw new d(r.error.message);return r.result??void 0}async let(r,e){let n=await this.rpc("let",[r,e]);if(n.error)throw new d(n.error.message);return!0}async unset(r){let e=await this.rpc("unset",[r]);if(e.error)throw new d(e.error.message);return!0}async live(r,e,n){await this.ready;let i=await this.rpc("live",[r,n]);if(i.error)throw new d(i.error.message);return e&&this.subscribeLive(i.result,e),i.result}async subscribeLive(r,e){if(await this.ready,!this.connection)throw new b;this.connection.emitter.subscribe(`live-${r}`,e,!0)}async unSubscribeLive(r,e){if(await this.ready,!this.connection)throw new b;this.connection.emitter.unSubscribe(`live-${r}`,e)}async kill(r){if(await this.ready,!this.connection)throw new b;if(Array.isArray(r)){await Promise.all(r.map(n=>this.rpc("kill",[n])));let e=r.map(n=>`live-${n}`);e.map(n=>this.emitter.emit(n,["CLOSE","killed"])),this.connection.emitter.reset({collectable:e,listeners:e})}else await this.rpc("kill",[r]),this.emitter.emit(`live-${r}`,["CLOSE","killed"]),this.connection.emitter.reset({collectable:`live-${r}`,listeners:`live-${r}`})}async query(...r){return(await this.queryRaw(...r)).map(({status:e,result:n})=>{if(e==="ERR")throw new d(n);return n})}async queryRaw(...[r,e]){let n=r instanceof kt?[r.query,Ue(r.bindings,{fills:e,replacer:M.encode})]:[r,e];await this.ready;let i=await this.rpc("query",n);if(i.error)throw new d(i.error.message);return i.result}async query_raw(...r){return this.queryRaw(...r)}async select(r){await this.ready;let e=await this.rpc("select",[r]);if(e.error)throw new d(e.error.message);return _(r,e.result)}async create(r,e){await this.ready;let n=await this.rpc("create",[r,e]);if(n.error)throw new d(n.error.message);return _(r,n.result)}async insert(r,e){await this.ready;let[n,i]=typeof r=="string"||r instanceof A?[r,e]:[void 0,r],o=await this.rpc("insert",[n,i]);if(o.error)throw new d(o.error.message);return o.result}async insertRelation(r,e){await this.ready;let[n,i]=typeof r=="string"||r instanceof A?[r,e]:[void 0,r],o=await this.rpc("insert_relation",[n,i]);if(o.error)throw new d(o.error.message);return o.result}async insert_relation(r,e){return r instanceof A||typeof r=="string"?this.insertRelation(r,e):this.insertRelation(r)}async update(r,e){await this.ready;let n=await this.rpc("update",[r,e]);if(n.error)throw new d(n.error.message);return _(r,n.result)}async upsert(r,e){await this.ready;let n=await this.rpc("upsert",[r,e]);if(n.error)throw new d(n.error.message);return _(r,n.result)}async merge(r,e){await this.ready;let n=await this.rpc("merge",[r,e]);if(n.error)throw new d(n.error.message);return _(r,n.result)}async patch(r,e,n){await this.ready;let i=await this.rpc("patch",[r,e,n]);if(i.error)throw new d(i.error.message);return n?i.result:_(r,i.result)}async delete(r){await this.ready;let e=await this.rpc("delete",[r]);if(e.error)throw new d(e.error.message);return _(r,e.result)}async version(){await this.ready;let r=await this.rpc("version");if(r.error)throw new d(r.error.message);return r.result}async run(r,e,n){await this.ready;let[i,o]=Array.isArray(e)?[void 0,e]:[e,n],s=await this.rpc("run",[r,i,o]);if(s.error)throw new d(s.error.message);return s.result}async relate(r,e,n,i){await this.ready;let o=await this.rpc("relate",[r,e,n,i]);if(o.error)throw new d(o.error.message);return _(e,o.result)}rpc(r,e){if(!this.connection)throw new b;return this.connection.rpc({method:r,params:e})}async export(r){if(await this.ready,!this.connection)throw new b;return this.connection.export(r)}async import(r){if(await this.ready,!this.connection)throw new b;return this.connection.import(r)}};function _(t,r){return t instanceof D||t instanceof V?Array.isArray(r)?r[0]:r:Array.isArray(r)?r:[r]}function Cr(t){let r=new URL(t);return r.pathname.endsWith("/rpc")||(r.pathname.endsWith("/")||(r.pathname+="/"),r.pathname+="rpc"),r}/*! Bundled license information:

uuidv7/dist/index.js:
  (**
   * uuidv7: A JavaScript implementation of UUID version 7
   *
   * @license Apache-2.0
   * @copyright 2021-2024 LiosK
   * @packageDocumentation
   *)
*/export{Ar as AbstractEngine,Mt as AuthController,j as BoundExcluded,I as BoundIncluded,K as CborBreak,U as CborError,mt as CborFillMissing,le as CborInvalidMajorError,me as CborNumberError,wt as CborPartialDisabled,g as CborRangeError,Sr as ConnectionStatus,N as ConnectionUnavailable,de as DEFAULT_RECONNECT_OPTIONS,P as Decimal,G as Duration,Vt as Emitter,It as EngineAuth,we as EngineDisconnected,Ir as FeatureUnavailableForEngine,oe as Future,ce as Gap,v as Geometry,Je as GeometryCollection,Ge as GeometryLine,Ve as GeometryMultiLine,Be as GeometryMultiPoint,Fe as GeometryMultiPolygon,$e as GeometryPoint,Pe as GeometryPolygon,zt as HttpConnectionError,Mr as InvalidURLProvided,Xt as MissingNamespaceDatabase,b as NoActiveSocket,Tr as NoConnectionDetails,Zt as NoDatabaseSpecified,Qt as NoNamespaceSpecified,De as NoTokenReturned,Wt as NoURLProvided,kt as PreparedQuery,C as Range,ke as ReconnectFailed,qt as ReconnectIterationError,D as RecordId,Se as RecordIdRange,d as ResponseError,V as StringRecordId,Vr as Surreal,u as SurrealDbError,A as Table,Yt as UnexpectedConnectionError,Dr as UnexpectedResponse,Te as UnexpectedServerResponse,Kt as UnsupportedEngine,Ht as UnsupportedVersion,E as Uuid,Me as VersionRetrievalFailure,Ft as cbor,lt as convertAuth,Gr as d,mr as decodeCbor,Vr as default,yr as defaultVersionCheckTimeout,wr as encodeCbor,T as equals,he as escapeIdent,sr as escapeNumber,jr as escape_ident,Dt as getIncrementalID,br as isLiveResult,_r as isVersionSupported,q as jsonify,gr as liveActions,Pr as r,Tt as retrieveRemoteVersion,Ce as s,Ne as supportedSurrealDbVersionMin,$r as supportedSurrealDbVersionRange,Oe as supportedSurrealDbVersionUntil,Lr as surql,Lr as surrealql,S as toSurrealqlString,Br as u,vr as versionCheck};
